\hypertarget{Stiffness_8cpp_source}{}\section{Stiffness.\+cpp}
\label{Stiffness_8cpp_source}\index{/home/corinne/eni\+Reservoir\+G\+I\+T\+H\+U\+B/eni\+Reservoir/\+F\+V\+Code3\+D/src/\+F\+V\+Code3\+D/assembler/\+Stiffness.\+cpp@{/home/corinne/eni\+Reservoir\+G\+I\+T\+H\+U\+B/eni\+Reservoir/\+F\+V\+Code3\+D/src/\+F\+V\+Code3\+D/assembler/\+Stiffness.\+cpp}}

\begin{DoxyCode}
00001 
00006 \textcolor{preprocessor}{#include <\hyperlink{Stiffness_8hpp}{FVCode3D/assembler/Stiffness.hpp}>}
00007 \textcolor{preprocessor}{#include <\hyperlink{Properties_8hpp}{FVCode3D/property/Properties.hpp}>}
00008 \textcolor{preprocessor}{#include <\hyperlink{Permeability_8hpp}{FVCode3D/property/Permeability.hpp}>}
00009 
00010 \textcolor{preprocessor}{#include <\hyperlink{ExportVTU_8hpp}{FVCode3D/export/ExportVTU.hpp}>}
00011 \textcolor{preprocessor}{#include <Eigen/LU>}
00012 \textcolor{preprocessor}{#include <unsupported/Eigen/SparseExtra>}
00013 
00014 \textcolor{comment}{// MFD: export some matrices, requires both INVERSEM and APPROXM}
00015 \textcolor{comment}{//#define MFD\_VERBOSE}
00016 
00017 \textcolor{keyword}{namespace }\hyperlink{namespaceFVCode3D}{FVCode3D}
00018 \{
00019 
\hypertarget{Stiffness_8cpp_source.tex_l00020}{}\hyperlink{classFVCode3D_1_1StiffMatrix_a2702adc80c0667f24005a16672de0d39}{00020} \hyperlink{classFVCode3D_1_1Point3D}{Point3D} \hyperlink{classFVCode3D_1_1StiffMatrix_a2702adc80c0667f24005a16672de0d39}{StiffMatrix::getBorderCenter}(
      \hyperlink{classFVCode3D_1_1StiffMatrix_ab6572f8976a3d7fc0d54d73888764252}{Fracture\_Juncture} fj)\textcolor{keyword}{ const}
00021 \textcolor{keyword}{}\{
00022     \textcolor{keywordflow}{return} (this->\hyperlink{classFVCode3D_1_1MatrixHandler_a72f185cb557fc2e8023bd09a074f685c}{M\_mesh}.\hyperlink{classFVCode3D_1_1Rigid__Mesh_a7acee1523c8da4596273627acc652609}{getNodesVector}()[fj.first] +
00023                 (this->\hyperlink{classFVCode3D_1_1MatrixHandler_a72f185cb557fc2e8023bd09a074f685c}{M\_mesh}.\hyperlink{classFVCode3D_1_1Rigid__Mesh_a7acee1523c8da4596273627acc652609}{getNodesVector}()[fj.second] -
00024                  this->\hyperlink{classFVCode3D_1_1MatrixHandler_a72f185cb557fc2e8023bd09a074f685c}{M\_mesh}.\hyperlink{classFVCode3D_1_1Rigid__Mesh_a7acee1523c8da4596273627acc652609}{getNodesVector}()[fj.first]
00025                 )/2.
00026            );
00027 \}
00028 
\hypertarget{Stiffness_8cpp_source.tex_l00029}{}\hyperlink{classFVCode3D_1_1StiffMatrix_a53ce514c7a4c784061b5339350e00995}{00029} \hyperlink{namespaceFVCode3D_a40c1f5588a248569d80aa5f867080e83}{Real} \hyperlink{classFVCode3D_1_1StiffMatrix_a53ce514c7a4c784061b5339350e00995}{StiffMatrix::findFracturesAlpha} (\textcolor{keyword}{const} 
      \hyperlink{classFVCode3D_1_1StiffMatrix_ab6572f8976a3d7fc0d54d73888764252}{Fracture\_Juncture} fj, \textcolor{keyword}{const} \hyperlink{namespaceFVCode3D_a4bf7e328c75d0fd504050d040ebe9eda}{UInt} n\_Id)\textcolor{keyword}{ const}
00030 \textcolor{keyword}{}\{
00031     \textcolor{keyword}{const} \hyperlink{classFVCode3D_1_1Point3D}{Point3D} borderCenter = \hyperlink{classFVCode3D_1_1StiffMatrix_a2702adc80c0667f24005a16672de0d39}{getBorderCenter}(fj);
00032     \textcolor{keyword}{const} \hyperlink{classFVCode3D_1_1Point3D}{Point3D} cellCenter = this->\hyperlink{classFVCode3D_1_1MatrixHandler_a72f185cb557fc2e8023bd09a074f685c}{M\_mesh}.
      \hyperlink{classFVCode3D_1_1Rigid__Mesh_aadbe6d9ad704122537903396d91238e0}{getFractureFacetsIdsVector}()[n\_Id].getCentroid();
00033 
00034     \textcolor{keyword}{const} \hyperlink{namespaceFVCode3D_a40c1f5588a248569d80aa5f867080e83}{Real} A = \hyperlink{classFVCode3D_1_1MatrixHandler_ad17a7941b1b8272f50fc6e1c660103fa}{M\_properties}.\hyperlink{classFVCode3D_1_1PropertiesMap_ace888d15c9a4ab13d5e217a3a565604c}{getProperties}(this->
      \hyperlink{classFVCode3D_1_1MatrixHandler_a72f185cb557fc2e8023bd09a074f685c}{M\_mesh}.\hyperlink{classFVCode3D_1_1Rigid__Mesh_aadbe6d9ad704122537903396d91238e0}{getFractureFacetsIdsVector}()[n\_Id].getZoneCode()).M\_aperture *
00035                   (this->\hyperlink{classFVCode3D_1_1MatrixHandler_a72f185cb557fc2e8023bd09a074f685c}{M\_mesh}.\hyperlink{classFVCode3D_1_1Rigid__Mesh_a7acee1523c8da4596273627acc652609}{getNodesVector}()[fj.second]-this->
      \hyperlink{classFVCode3D_1_1MatrixHandler_a72f185cb557fc2e8023bd09a074f685c}{M\_mesh}.\hyperlink{classFVCode3D_1_1Rigid__Mesh_a7acee1523c8da4596273627acc652609}{getNodesVector}()[fj.first]).norm();
00036 
00037     \textcolor{keyword}{const} \hyperlink{namespaceFVCode3D_aee5ae48a57366603109f90f526a645b1}{PermPtr\_Type} & k =
00038             \hyperlink{classFVCode3D_1_1MatrixHandler_ad17a7941b1b8272f50fc6e1c660103fa}{M\_properties}.\hyperlink{classFVCode3D_1_1PropertiesMap_ace888d15c9a4ab13d5e217a3a565604c}{getProperties}(this->\hyperlink{classFVCode3D_1_1MatrixHandler_a72f185cb557fc2e8023bd09a074f685c}{M\_mesh}.
      \hyperlink{classFVCode3D_1_1Rigid__Mesh_aadbe6d9ad704122537903396d91238e0}{getFractureFacetsIdsVector}()[n\_Id].getZoneCode()).M\_permeability;
00039 
00040     \hyperlink{classFVCode3D_1_1Point3D}{Point3D} f = borderCenter - cellCenter;
00041     \textcolor{keyword}{const} \hyperlink{namespaceFVCode3D_a40c1f5588a248569d80aa5f867080e83}{Real} D = sqrt(\hyperlink{namespaceFVCode3D_ad07be7f9ed843ca65d02d0303dae6cb4}{dotProduct}(f, f));
00042     assert( D != 0 );
00043 
00044     f /= D;
00045 
00046     \hyperlink{classFVCode3D_1_1Point3D}{Point3D} normal = \hyperlink{namespaceFVCode3D_a1ee7c9a5fcc645574f6a93e5f6f53b4b}{crossProduct}(f, this->\hyperlink{classFVCode3D_1_1MatrixHandler_a72f185cb557fc2e8023bd09a074f685c}{M\_mesh}.
      \hyperlink{classFVCode3D_1_1Rigid__Mesh_a7acee1523c8da4596273627acc652609}{getNodesVector}()[fj.second]-this->\hyperlink{classFVCode3D_1_1MatrixHandler_a72f185cb557fc2e8023bd09a074f685c}{M\_mesh}.\hyperlink{classFVCode3D_1_1Rigid__Mesh_a7acee1523c8da4596273627acc652609}{getNodesVector}()[fj.first]); \textcolor{comment}{//
       k = f x l}
00047     normal = \hyperlink{namespaceFVCode3D_a1ee7c9a5fcc645574f6a93e5f6f53b4b}{crossProduct}(this->\hyperlink{classFVCode3D_1_1MatrixHandler_a72f185cb557fc2e8023bd09a074f685c}{M\_mesh}.\hyperlink{classFVCode3D_1_1Rigid__Mesh_a7acee1523c8da4596273627acc652609}{getNodesVector}()[fj.second]-this->
      \hyperlink{classFVCode3D_1_1MatrixHandler_a72f185cb557fc2e8023bd09a074f685c}{M\_mesh}.\hyperlink{classFVCode3D_1_1Rigid__Mesh_a7acee1523c8da4596273627acc652609}{getNodesVector}()[fj.first], normal); \textcolor{comment}{// n = l x k}
00048     normal.\hyperlink{classFVCode3D_1_1Point3D_a0d1cd3d114b0985ae2b11cd1c52de673}{normalize}();
00049 
00050     \textcolor{keyword}{const} \hyperlink{namespaceFVCode3D_a40c1f5588a248569d80aa5f867080e83}{Real} KnDotF = fabs(\hyperlink{namespaceFVCode3D_ad07be7f9ed843ca65d02d0303dae6cb4}{dotProduct}(k * normal, f)); \textcolor{comment}{// K n * f}
00051 
00052     \textcolor{keywordflow}{return} A * KnDotF / D;
00053 \}
00054 
\hypertarget{Stiffness_8cpp_source.tex_l00055}{}\hyperlink{classFVCode3D_1_1StiffMatrix_a2365673b4791819e78c4c593e2f63b28}{00055} \hyperlink{namespaceFVCode3D_a40c1f5588a248569d80aa5f867080e83}{Real} \hyperlink{classFVCode3D_1_1StiffMatrix_a2365673b4791819e78c4c593e2f63b28}{StiffMatrix::findAlpha} (\textcolor{keyword}{const} \hyperlink{namespaceFVCode3D_a4bf7e328c75d0fd504050d040ebe9eda}{UInt} & cellId, \textcolor{keyword}{const} 
      \hyperlink{classFVCode3D_1_1Rigid__Mesh_1_1Facet__ID}{Facet\_ID} * facet)\textcolor{keyword}{ const}
00056 \textcolor{keyword}{}\{
00057     \textcolor{keyword}{const} \hyperlink{classFVCode3D_1_1Point3D}{Point3D} facetCenter = facet->\hyperlink{classFVCode3D_1_1Rigid__Mesh_1_1Facet__ID_afd11bc5dcc915bbe6a9c39f333e336ff}{getCentroid}();
00058     \textcolor{keyword}{const} \hyperlink{classFVCode3D_1_1Point3D}{Point3D} cellCenter = this->\hyperlink{classFVCode3D_1_1MatrixHandler_a72f185cb557fc2e8023bd09a074f685c}{M\_mesh}.\hyperlink{classFVCode3D_1_1Rigid__Mesh_afefb62f2c37317402b495e2369ed495b}{getCellsVector}()[cellId].getCentroid
      ();
00059 
00060     \textcolor{keyword}{const} \hyperlink{namespaceFVCode3D_aee5ae48a57366603109f90f526a645b1}{PermPtr\_Type} & k =
00061             \hyperlink{classFVCode3D_1_1MatrixHandler_ad17a7941b1b8272f50fc6e1c660103fa}{M\_properties}.\hyperlink{classFVCode3D_1_1PropertiesMap_ace888d15c9a4ab13d5e217a3a565604c}{getProperties}(this->\hyperlink{classFVCode3D_1_1MatrixHandler_a72f185cb557fc2e8023bd09a074f685c}{M\_mesh}.
      \hyperlink{classFVCode3D_1_1Rigid__Mesh_afefb62f2c37317402b495e2369ed495b}{getCellsVector}()[cellId].getZoneCode()).M\_permeability;
00062 
00063     \hyperlink{classFVCode3D_1_1Point3D}{Point3D} f = cellCenter - facetCenter;
00064     \textcolor{keyword}{const} \hyperlink{namespaceFVCode3D_a40c1f5588a248569d80aa5f867080e83}{Real} D = sqrt(\hyperlink{namespaceFVCode3D_ad07be7f9ed843ca65d02d0303dae6cb4}{dotProduct}(f, f));
00065     assert( D != 0 );
00066 
00067     f /= D;
00068 
00069     \textcolor{keyword}{const} \hyperlink{classFVCode3D_1_1Point3D}{Point3D} normal = facet->\hyperlink{classFVCode3D_1_1Rigid__Mesh_1_1Facet__ID_a20ee7f532091bf919c6bad0797221336}{getUnsignedNormal}();
00070 
00071     \textcolor{keyword}{const} \hyperlink{namespaceFVCode3D_a40c1f5588a248569d80aa5f867080e83}{Real} KnDotF = fabs(\hyperlink{namespaceFVCode3D_ad07be7f9ed843ca65d02d0303dae6cb4}{dotProduct}(k * normal, f)); \textcolor{comment}{// K n * f}
00072 
00073     \textcolor{keywordflow}{return} facet->\hyperlink{classFVCode3D_1_1Rigid__Mesh_1_1Facet__ID_a6fb6374e6750efc29b8ca9fa4d329d7b}{getSize}() * KnDotF / D;
00074 \}
00075 
\hypertarget{Stiffness_8cpp_source.tex_l00076}{}\hyperlink{classFVCode3D_1_1StiffMatrix_ae11e5b16122aed418d90e18530007e11}{00076} \hyperlink{namespaceFVCode3D_a40c1f5588a248569d80aa5f867080e83}{Real} \hyperlink{classFVCode3D_1_1StiffMatrix_a2365673b4791819e78c4c593e2f63b28}{StiffMatrix::findAlpha} (\textcolor{keyword}{const} \hyperlink{namespaceFVCode3D_a4bf7e328c75d0fd504050d040ebe9eda}{UInt} & facetId, \textcolor{keyword}{const} 
      \hyperlink{classFVCode3D_1_1Rigid__Mesh_1_1Edge__ID}{Edge\_ID} * edge)\textcolor{keyword}{ const}
00077 \textcolor{keyword}{}\{
00078     \textcolor{keyword}{const} \hyperlink{classFVCode3D_1_1Point3D}{Point3D} edgeCenter = edge->\hyperlink{classFVCode3D_1_1Rigid__Mesh_1_1Edge__ID_ab6f4cafa57b3e7116b815ee96aaf701c}{getCentroid}();
00079     \textcolor{keyword}{const} \hyperlink{classFVCode3D_1_1Point3D}{Point3D} facetCenter = this->\hyperlink{classFVCode3D_1_1MatrixHandler_a72f185cb557fc2e8023bd09a074f685c}{M\_mesh}.\hyperlink{classFVCode3D_1_1Rigid__Mesh_a6d3cdd4ef8a5225599953179d5302636}{getFacetsVector}()[facetId].
      getCentroid();
00080 
00081     \textcolor{keyword}{const} \hyperlink{namespaceFVCode3D_a40c1f5588a248569d80aa5f867080e83}{Real} A = edge->\hyperlink{classFVCode3D_1_1Rigid__Mesh_1_1Edge__ID_a3834b95f5044df3e95afb2bf657693f6}{getSize}() *
00082                    \hyperlink{classFVCode3D_1_1MatrixHandler_ad17a7941b1b8272f50fc6e1c660103fa}{M\_properties}.\hyperlink{classFVCode3D_1_1PropertiesMap_ace888d15c9a4ab13d5e217a3a565604c}{getProperties}(this->
      \hyperlink{classFVCode3D_1_1MatrixHandler_a72f185cb557fc2e8023bd09a074f685c}{M\_mesh}.\hyperlink{classFVCode3D_1_1Rigid__Mesh_a6d3cdd4ef8a5225599953179d5302636}{getFacetsVector}()[facetId].getZoneCode()).M\_aperture;
00083 
00084     \textcolor{keyword}{const} \hyperlink{namespaceFVCode3D_aee5ae48a57366603109f90f526a645b1}{PermPtr\_Type} & k =
00085             \hyperlink{classFVCode3D_1_1MatrixHandler_ad17a7941b1b8272f50fc6e1c660103fa}{M\_properties}.\hyperlink{classFVCode3D_1_1PropertiesMap_ace888d15c9a4ab13d5e217a3a565604c}{getProperties}(this->\hyperlink{classFVCode3D_1_1MatrixHandler_a72f185cb557fc2e8023bd09a074f685c}{M\_mesh}.
      \hyperlink{classFVCode3D_1_1Rigid__Mesh_a6d3cdd4ef8a5225599953179d5302636}{getFacetsVector}()[facetId].getZoneCode()).M\_permeability;
00086 
00087     \hyperlink{classFVCode3D_1_1Point3D}{Point3D} f = edgeCenter - facetCenter;
00088     \textcolor{keyword}{const} \hyperlink{namespaceFVCode3D_a40c1f5588a248569d80aa5f867080e83}{Real} D = sqrt(\hyperlink{namespaceFVCode3D_ad07be7f9ed843ca65d02d0303dae6cb4}{dotProduct}(f, f));
00089     assert( D != 0 );
00090 
00091     f /= D;
00092 
00093     \hyperlink{classFVCode3D_1_1Point3D}{Point3D} normal = \hyperlink{namespaceFVCode3D_a1ee7c9a5fcc645574f6a93e5f6f53b4b}{crossProduct}(  f,
00094                             this->\hyperlink{classFVCode3D_1_1MatrixHandler_a72f185cb557fc2e8023bd09a074f685c}{M\_mesh}.\hyperlink{classFVCode3D_1_1Rigid__Mesh_a7acee1523c8da4596273627acc652609}{getNodesVector}()[edge->
      \hyperlink{classFVCode3D_1_1Rigid__Mesh_1_1Edge__ID_a389e2ca5b81b7256dfadb2150eefcd2e}{getEdge}().\hyperlink{classFVCode3D_1_1Rigid__Mesh_1_1Edge_a24050b2332146cdfa44b8833a72bf6a6}{getVerticesIds}()[0]] -
00095                             this->\hyperlink{classFVCode3D_1_1MatrixHandler_a72f185cb557fc2e8023bd09a074f685c}{M\_mesh}.\hyperlink{classFVCode3D_1_1Rigid__Mesh_a7acee1523c8da4596273627acc652609}{getNodesVector}()[edge->
      \hyperlink{classFVCode3D_1_1Rigid__Mesh_1_1Edge__ID_a389e2ca5b81b7256dfadb2150eefcd2e}{getEdge}().\hyperlink{classFVCode3D_1_1Rigid__Mesh_1_1Edge_a24050b2332146cdfa44b8833a72bf6a6}{getVerticesIds}()[1]] ); \textcolor{comment}{// k = f x l}
00096     normal = \hyperlink{namespaceFVCode3D_a1ee7c9a5fcc645574f6a93e5f6f53b4b}{crossProduct}(  this->\hyperlink{classFVCode3D_1_1MatrixHandler_a72f185cb557fc2e8023bd09a074f685c}{M\_mesh}.\hyperlink{classFVCode3D_1_1Rigid__Mesh_a7acee1523c8da4596273627acc652609}{getNodesVector}()[edge->
      \hyperlink{classFVCode3D_1_1Rigid__Mesh_1_1Edge__ID_a389e2ca5b81b7256dfadb2150eefcd2e}{getEdge}().\hyperlink{classFVCode3D_1_1Rigid__Mesh_1_1Edge_a24050b2332146cdfa44b8833a72bf6a6}{getVerticesIds}()[0]] -
00097                             this->\hyperlink{classFVCode3D_1_1MatrixHandler_a72f185cb557fc2e8023bd09a074f685c}{M\_mesh}.\hyperlink{classFVCode3D_1_1Rigid__Mesh_a7acee1523c8da4596273627acc652609}{getNodesVector}()[edge->
      \hyperlink{classFVCode3D_1_1Rigid__Mesh_1_1Edge__ID_a389e2ca5b81b7256dfadb2150eefcd2e}{getEdge}().\hyperlink{classFVCode3D_1_1Rigid__Mesh_1_1Edge_a24050b2332146cdfa44b8833a72bf6a6}{getVerticesIds}()[1]],
00098                             normal); \textcolor{comment}{// n = l x k}
00099     normal.\hyperlink{classFVCode3D_1_1Point3D_a0d1cd3d114b0985ae2b11cd1c52de673}{normalize}();
00100 
00101     \textcolor{keyword}{const} \hyperlink{namespaceFVCode3D_a40c1f5588a248569d80aa5f867080e83}{Real} KnDotF = fabs(\hyperlink{namespaceFVCode3D_ad07be7f9ed843ca65d02d0303dae6cb4}{dotProduct}(k * normal, f)); \textcolor{comment}{// K n * f}
00102 
00103     \textcolor{keywordflow}{return} A * KnDotF / D;
00104 \}
00105 
\hypertarget{Stiffness_8cpp_source.tex_l00106}{}\hyperlink{classFVCode3D_1_1StiffMatrix_aec36126e4870fc3f94a2d36b831c739e}{00106} \hyperlink{namespaceFVCode3D_a40c1f5588a248569d80aa5f867080e83}{Real} \hyperlink{classFVCode3D_1_1StiffMatrix_aec36126e4870fc3f94a2d36b831c739e}{StiffMatrix::findDirichletAlpha} (\textcolor{keyword}{const} 
      \hyperlink{namespaceFVCode3D_a4bf7e328c75d0fd504050d040ebe9eda}{UInt} & cellId, \textcolor{keyword}{const} \hyperlink{classFVCode3D_1_1Rigid__Mesh_1_1Facet__ID}{Facet\_ID} * facet)\textcolor{keyword}{ const}
00107 \textcolor{keyword}{}\{
00108     \textcolor{keyword}{const} \hyperlink{classFVCode3D_1_1Point3D}{Point3D} facetCenter = facet->\hyperlink{classFVCode3D_1_1Rigid__Mesh_1_1Facet__ID_afd11bc5dcc915bbe6a9c39f333e336ff}{getCentroid}();
00109     \textcolor{keyword}{const} \hyperlink{classFVCode3D_1_1Point3D}{Point3D} cellCenter = this->\hyperlink{classFVCode3D_1_1MatrixHandler_a72f185cb557fc2e8023bd09a074f685c}{M\_mesh}.\hyperlink{classFVCode3D_1_1Rigid__Mesh_afefb62f2c37317402b495e2369ed495b}{getCellsVector}()[cellId].getCentroid
      ();
00110 
00111     \textcolor{keyword}{const} \hyperlink{namespaceFVCode3D_aee5ae48a57366603109f90f526a645b1}{PermPtr\_Type} & k =
00112             \hyperlink{classFVCode3D_1_1MatrixHandler_ad17a7941b1b8272f50fc6e1c660103fa}{M\_properties}.\hyperlink{classFVCode3D_1_1PropertiesMap_ace888d15c9a4ab13d5e217a3a565604c}{getProperties}(this->\hyperlink{classFVCode3D_1_1MatrixHandler_a72f185cb557fc2e8023bd09a074f685c}{M\_mesh}.
      \hyperlink{classFVCode3D_1_1Rigid__Mesh_afefb62f2c37317402b495e2369ed495b}{getCellsVector}()[cellId].getZoneCode()).M\_permeability;
00113 
00114     \hyperlink{classFVCode3D_1_1Point3D}{Point3D} f = cellCenter - facetCenter;
00115     \textcolor{keyword}{const} \hyperlink{namespaceFVCode3D_a40c1f5588a248569d80aa5f867080e83}{Real} D = sqrt(\hyperlink{namespaceFVCode3D_ad07be7f9ed843ca65d02d0303dae6cb4}{dotProduct}(f, f));
00116     assert( D != 0 );
00117 
00118     f /= D;
00119 
00120     \textcolor{keyword}{const} \hyperlink{classFVCode3D_1_1Point3D}{Point3D} normal = facet->\hyperlink{classFVCode3D_1_1Rigid__Mesh_1_1Facet__ID_a20ee7f532091bf919c6bad0797221336}{getUnsignedNormal}();
00121 
00122     \textcolor{keyword}{const} \hyperlink{namespaceFVCode3D_a40c1f5588a248569d80aa5f867080e83}{Real} KnDotF = fabs(\hyperlink{namespaceFVCode3D_ad07be7f9ed843ca65d02d0303dae6cb4}{dotProduct}(k * normal, f)); \textcolor{comment}{// K n * f}
00123 
00124     \textcolor{keywordflow}{return} facet->\hyperlink{classFVCode3D_1_1Rigid__Mesh_1_1Facet__ID_a6fb6374e6750efc29b8ca9fa4d329d7b}{getSize}() * KnDotF / D;
00125 \}
00126 
\hypertarget{Stiffness_8cpp_source.tex_l00127}{}\hyperlink{classFVCode3D_1_1StiffMatrix_a478ef47118fb9c83531695e0eaaa62a6}{00127} \hyperlink{namespaceFVCode3D_a40c1f5588a248569d80aa5f867080e83}{Real} \hyperlink{classFVCode3D_1_1StiffMatrix_aec36126e4870fc3f94a2d36b831c739e}{StiffMatrix::findDirichletAlpha} (\textcolor{keyword}{const} 
      \hyperlink{namespaceFVCode3D_a4bf7e328c75d0fd504050d040ebe9eda}{UInt} & facetId, \textcolor{keyword}{const} \hyperlink{classFVCode3D_1_1Rigid__Mesh_1_1Edge__ID}{Edge\_ID} * edge)\textcolor{keyword}{ const}
00128 \textcolor{keyword}{}\{
00129     \textcolor{keyword}{const} \hyperlink{classFVCode3D_1_1Point3D}{Point3D} borderCenter = edge->\hyperlink{classFVCode3D_1_1Rigid__Mesh_1_1Edge__ID_ab6f4cafa57b3e7116b815ee96aaf701c}{getCentroid}();
00130     \textcolor{keyword}{const} \hyperlink{classFVCode3D_1_1Point3D}{Point3D} facetCenter = this->\hyperlink{classFVCode3D_1_1MatrixHandler_a72f185cb557fc2e8023bd09a074f685c}{M\_mesh}.\hyperlink{classFVCode3D_1_1Rigid__Mesh_a6d3cdd4ef8a5225599953179d5302636}{getFacetsVector}()[facetId].
      getCentroid();
00131 
00132     \textcolor{keyword}{const} \hyperlink{namespaceFVCode3D_a40c1f5588a248569d80aa5f867080e83}{Real} A = edge->\hyperlink{classFVCode3D_1_1Rigid__Mesh_1_1Edge__ID_a3834b95f5044df3e95afb2bf657693f6}{getSize}() *
00133                    \hyperlink{classFVCode3D_1_1MatrixHandler_ad17a7941b1b8272f50fc6e1c660103fa}{M\_properties}.\hyperlink{classFVCode3D_1_1PropertiesMap_ace888d15c9a4ab13d5e217a3a565604c}{getProperties}(this->
      \hyperlink{classFVCode3D_1_1MatrixHandler_a72f185cb557fc2e8023bd09a074f685c}{M\_mesh}.\hyperlink{classFVCode3D_1_1Rigid__Mesh_a6d3cdd4ef8a5225599953179d5302636}{getFacetsVector}()[facetId].getZoneCode()).M\_aperture;
00134 
00135     \textcolor{keyword}{const} \hyperlink{namespaceFVCode3D_aee5ae48a57366603109f90f526a645b1}{PermPtr\_Type} & k =
00136             \hyperlink{classFVCode3D_1_1MatrixHandler_ad17a7941b1b8272f50fc6e1c660103fa}{M\_properties}.\hyperlink{classFVCode3D_1_1PropertiesMap_ace888d15c9a4ab13d5e217a3a565604c}{getProperties}(this->\hyperlink{classFVCode3D_1_1MatrixHandler_a72f185cb557fc2e8023bd09a074f685c}{M\_mesh}.
      \hyperlink{classFVCode3D_1_1Rigid__Mesh_a6d3cdd4ef8a5225599953179d5302636}{getFacetsVector}()[facetId].getZoneCode()).M\_permeability;
00137 
00138     \hyperlink{classFVCode3D_1_1Point3D}{Point3D} f = borderCenter - facetCenter;
00139     \textcolor{keyword}{const} \hyperlink{namespaceFVCode3D_a40c1f5588a248569d80aa5f867080e83}{Real} D = sqrt(\hyperlink{namespaceFVCode3D_ad07be7f9ed843ca65d02d0303dae6cb4}{dotProduct}(f, f));
00140     assert( D != 0 );
00141 
00142     f /= D;
00143 
00144     \hyperlink{classFVCode3D_1_1Point3D}{Point3D} normal = \hyperlink{namespaceFVCode3D_a1ee7c9a5fcc645574f6a93e5f6f53b4b}{crossProduct}(  f,
00145                             this->\hyperlink{classFVCode3D_1_1MatrixHandler_a72f185cb557fc2e8023bd09a074f685c}{M\_mesh}.\hyperlink{classFVCode3D_1_1Rigid__Mesh_a7acee1523c8da4596273627acc652609}{getNodesVector}()[edge->
      \hyperlink{classFVCode3D_1_1Rigid__Mesh_1_1Edge__ID_a389e2ca5b81b7256dfadb2150eefcd2e}{getEdge}().\hyperlink{classFVCode3D_1_1Rigid__Mesh_1_1Edge_a24050b2332146cdfa44b8833a72bf6a6}{getVerticesIds}()[0]] -
00146                             this->\hyperlink{classFVCode3D_1_1MatrixHandler_a72f185cb557fc2e8023bd09a074f685c}{M\_mesh}.\hyperlink{classFVCode3D_1_1Rigid__Mesh_a7acee1523c8da4596273627acc652609}{getNodesVector}()[edge->
      \hyperlink{classFVCode3D_1_1Rigid__Mesh_1_1Edge__ID_a389e2ca5b81b7256dfadb2150eefcd2e}{getEdge}().\hyperlink{classFVCode3D_1_1Rigid__Mesh_1_1Edge_a24050b2332146cdfa44b8833a72bf6a6}{getVerticesIds}()[1]] ); \textcolor{comment}{// k = f x l}
00147     normal = \hyperlink{namespaceFVCode3D_a1ee7c9a5fcc645574f6a93e5f6f53b4b}{crossProduct}(  this->\hyperlink{classFVCode3D_1_1MatrixHandler_a72f185cb557fc2e8023bd09a074f685c}{M\_mesh}.\hyperlink{classFVCode3D_1_1Rigid__Mesh_a7acee1523c8da4596273627acc652609}{getNodesVector}()[edge->
      \hyperlink{classFVCode3D_1_1Rigid__Mesh_1_1Edge__ID_a389e2ca5b81b7256dfadb2150eefcd2e}{getEdge}().\hyperlink{classFVCode3D_1_1Rigid__Mesh_1_1Edge_a24050b2332146cdfa44b8833a72bf6a6}{getVerticesIds}()[0]] -
00148                             this->\hyperlink{classFVCode3D_1_1MatrixHandler_a72f185cb557fc2e8023bd09a074f685c}{M\_mesh}.\hyperlink{classFVCode3D_1_1Rigid__Mesh_a7acee1523c8da4596273627acc652609}{getNodesVector}()[edge->
      \hyperlink{classFVCode3D_1_1Rigid__Mesh_1_1Edge__ID_a389e2ca5b81b7256dfadb2150eefcd2e}{getEdge}().\hyperlink{classFVCode3D_1_1Rigid__Mesh_1_1Edge_a24050b2332146cdfa44b8833a72bf6a6}{getVerticesIds}()[1]],
00149                             normal); \textcolor{comment}{// n = l x k}
00150     normal.\hyperlink{classFVCode3D_1_1Point3D_a0d1cd3d114b0985ae2b11cd1c52de673}{normalize}();
00151 
00152     \textcolor{keyword}{const} \hyperlink{namespaceFVCode3D_a40c1f5588a248569d80aa5f867080e83}{Real} KnDotF = fabs(\hyperlink{namespaceFVCode3D_ad07be7f9ed843ca65d02d0303dae6cb4}{dotProduct}(k * normal, f)); \textcolor{comment}{// K n * f}
00153 
00154     \textcolor{keywordflow}{return} A * KnDotF / D;
00155 \}
00156 
\hypertarget{Stiffness_8cpp_source.tex_l00157}{}\hyperlink{classFVCode3D_1_1StiffMatrix_af63e81815a2ba8bd62a2156a80adce55}{00157} \textcolor{keywordtype}{void} \hyperlink{classFVCode3D_1_1StiffMatrix_af63e81815a2ba8bd62a2156a80adce55}{StiffMatrix::assemble}()
00158 \{
00159     \textcolor{comment}{// TODO reserve the vector!}
00160 
00161     \textcolor{keywordflow}{if}( !this->\hyperlink{classFVCode3D_1_1MatrixHandler_a72f185cb557fc2e8023bd09a074f685c}{M\_mesh}.\hyperlink{classFVCode3D_1_1Rigid__Mesh_a838ebf69155c115c2646d1a20b0ad249}{getInternalFacetsIdsVector}().empty() )
00162     \{
00163         \hyperlink{classFVCode3D_1_1StiffMatrix_a94c6757030321f8f557a6625e1bc2706}{assemblePorousMatrix}();
00164     \} \textcolor{comment}{// if}
00165 
00166     \textcolor{keywordflow}{if}( !this->\hyperlink{classFVCode3D_1_1MatrixHandler_a72f185cb557fc2e8023bd09a074f685c}{M\_mesh}.\hyperlink{classFVCode3D_1_1Rigid__Mesh_aadbe6d9ad704122537903396d91238e0}{getFractureFacetsIdsVector}().empty() )
00167     \{
00168         \hyperlink{classFVCode3D_1_1StiffMatrix_a14fa2721385e2cc9c0c179c2cff6e618}{assembleFracture}();
00169     \} \textcolor{comment}{// if}
00170 
00171     \textcolor{keywordflow}{if}( !this->\hyperlink{classFVCode3D_1_1MatrixHandler_a72f185cb557fc2e8023bd09a074f685c}{M\_mesh}.\hyperlink{classFVCode3D_1_1Rigid__Mesh_aa72b7fad937f0d1586fc10b176ef5d3e}{getBorderFacetsIdsVector}().empty() )
00172     \{
00173         \hyperlink{classFVCode3D_1_1StiffMatrix_aee24f1b77e66c0bb7be4efbf43671c44}{assemblePorousMatrixBC}();
00174     \} \textcolor{comment}{// if}
00175 
00176     \textcolor{keywordflow}{if}( !this->\hyperlink{classFVCode3D_1_1MatrixHandler_a72f185cb557fc2e8023bd09a074f685c}{M\_mesh}.\hyperlink{classFVCode3D_1_1Rigid__Mesh_a12c92b683cfb3d9ac2645f038a8c6220}{getBorderTipEdgesIdsVector}().empty() )
00177     \{
00178         \hyperlink{classFVCode3D_1_1StiffMatrix_af7e80d2641fc41174eb4cb56e2f119d4}{assembleFractureBC}();
00179     \} \textcolor{comment}{// if}
00180 \} \textcolor{comment}{// assemble}
00181 
\hypertarget{Stiffness_8cpp_source.tex_l00182}{}\hyperlink{classFVCode3D_1_1StiffMatrix_a94c6757030321f8f557a6625e1bc2706}{00182} \textcolor{keywordtype}{void} \hyperlink{classFVCode3D_1_1StiffMatrix_a94c6757030321f8f557a6625e1bc2706}{StiffMatrix::assemblePorousMatrix}()
00183 \{
00184     \textcolor{keywordflow}{for} (\textcolor{keyword}{auto}& facet\_it : this->\hyperlink{classFVCode3D_1_1MatrixHandler_a72f185cb557fc2e8023bd09a074f685c}{M\_mesh}.\hyperlink{classFVCode3D_1_1Rigid__Mesh_a838ebf69155c115c2646d1a20b0ad249}{getInternalFacetsIdsVector}())
00185     \{
00186         \textcolor{keyword}{const} \hyperlink{namespaceFVCode3D_a4bf7e328c75d0fd504050d040ebe9eda}{UInt} neighbor1id = facet\_it.getSeparatedCellsIds()[0];
00187         \textcolor{keyword}{const} \hyperlink{namespaceFVCode3D_a4bf7e328c75d0fd504050d040ebe9eda}{UInt} neighbor2id = facet\_it.getSeparatedCellsIds()[1];
00188 
00189         \textcolor{keyword}{const} \hyperlink{namespaceFVCode3D_a40c1f5588a248569d80aa5f867080e83}{Real} alpha1 = \hyperlink{classFVCode3D_1_1StiffMatrix_a2365673b4791819e78c4c593e2f63b28}{findAlpha}(neighbor1id, &facet\_it);
00190         \textcolor{keyword}{const} \hyperlink{namespaceFVCode3D_a40c1f5588a248569d80aa5f867080e83}{Real} alpha2 = \hyperlink{classFVCode3D_1_1StiffMatrix_a2365673b4791819e78c4c593e2f63b28}{findAlpha}(neighbor2id, &facet\_it);
00191         assert( ( alpha1 + alpha2 ) != 0 );
00192 
00193         \textcolor{keyword}{const} \hyperlink{namespaceFVCode3D_a40c1f5588a248569d80aa5f867080e83}{Real} T12 = alpha1*alpha2/(alpha1 + alpha2);
00194         \textcolor{keyword}{const} \hyperlink{namespaceFVCode3D_a40c1f5588a248569d80aa5f867080e83}{Real} Q12 = T12 * \hyperlink{classFVCode3D_1_1MatrixHandler_ad17a7941b1b8272f50fc6e1c660103fa}{M\_properties}.\hyperlink{classFVCode3D_1_1PropertiesMap_a810ea62ca881e4db57acd601bcea23cf}{getMobility}();
00195 
00196         \hyperlink{classFVCode3D_1_1MatrixHandler_a0bbdfb8d779ca20d8ba69b99cac1f4d6}{M\_matrixElements}.emplace\_back(\hyperlink{classFVCode3D_1_1MatrixHandler_ad3faa8b15bca6e0052be8c868b924444}{M\_offsetRow} + neighbor1id, 
      \hyperlink{classFVCode3D_1_1MatrixHandler_a6ec7cf5178c1c25b54abc46ff0affcf2}{M\_offsetCol} + neighbor1id, Q12); \textcolor{comment}{// Triplet}
00197         \hyperlink{classFVCode3D_1_1MatrixHandler_a0bbdfb8d779ca20d8ba69b99cac1f4d6}{M\_matrixElements}.emplace\_back(\hyperlink{classFVCode3D_1_1MatrixHandler_ad3faa8b15bca6e0052be8c868b924444}{M\_offsetRow} + neighbor1id, 
      \hyperlink{classFVCode3D_1_1MatrixHandler_a6ec7cf5178c1c25b54abc46ff0affcf2}{M\_offsetCol} + neighbor2id, -Q12); \textcolor{comment}{// Triplet}
00198         \hyperlink{classFVCode3D_1_1MatrixHandler_a0bbdfb8d779ca20d8ba69b99cac1f4d6}{M\_matrixElements}.emplace\_back(\hyperlink{classFVCode3D_1_1MatrixHandler_ad3faa8b15bca6e0052be8c868b924444}{M\_offsetRow} + neighbor2id, 
      \hyperlink{classFVCode3D_1_1MatrixHandler_a6ec7cf5178c1c25b54abc46ff0affcf2}{M\_offsetCol} + neighbor1id, -Q12); \textcolor{comment}{// Triplet}
00199         \hyperlink{classFVCode3D_1_1MatrixHandler_a0bbdfb8d779ca20d8ba69b99cac1f4d6}{M\_matrixElements}.emplace\_back(\hyperlink{classFVCode3D_1_1MatrixHandler_ad3faa8b15bca6e0052be8c868b924444}{M\_offsetRow} + neighbor2id, 
      \hyperlink{classFVCode3D_1_1MatrixHandler_a6ec7cf5178c1c25b54abc46ff0affcf2}{M\_offsetCol} + neighbor2id, Q12); \textcolor{comment}{// Triplet}
00200     \} \textcolor{comment}{// for}
00201 
00202     \textcolor{keywordflow}{for} (\textcolor{keyword}{auto}& facet\_it : this->\hyperlink{classFVCode3D_1_1MatrixHandler_a72f185cb557fc2e8023bd09a074f685c}{M\_mesh}.\hyperlink{classFVCode3D_1_1Rigid__Mesh_aadbe6d9ad704122537903396d91238e0}{getFractureFacetsIdsVector}())
00203     \{
00204         \textcolor{keyword}{const} \hyperlink{namespaceFVCode3D_aee5ae48a57366603109f90f526a645b1}{PermPtr\_Type} & F\_permeability = \hyperlink{classFVCode3D_1_1MatrixHandler_ad17a7941b1b8272f50fc6e1c660103fa}{M\_properties}.
      \hyperlink{classFVCode3D_1_1PropertiesMap_ace888d15c9a4ab13d5e217a3a565604c}{getProperties}(facet\_it.getZoneCode()).M\_permeability;
00205         \textcolor{keyword}{const} \hyperlink{namespaceFVCode3D_a40c1f5588a248569d80aa5f867080e83}{Real} F\_aperture = \hyperlink{classFVCode3D_1_1MatrixHandler_ad17a7941b1b8272f50fc6e1c660103fa}{M\_properties}.\hyperlink{classFVCode3D_1_1PropertiesMap_ace888d15c9a4ab13d5e217a3a565604c}{getProperties}(facet\_it.
      getZoneCode()).M\_aperture;
00206         \textcolor{keyword}{const} \hyperlink{namespaceFVCode3D_a40c1f5588a248569d80aa5f867080e83}{Real} Df = F\_aperture/2.;
00207         assert( Df != 0 );
00208 
00209         \hyperlink{classFVCode3D_1_1Point3D}{Point3D} normal = facet\_it.getUnsignedNormal();
00210 
00211         \textcolor{keyword}{const} \hyperlink{namespaceFVCode3D_a40c1f5588a248569d80aa5f867080e83}{Real} KnDotF = fabs(\hyperlink{namespaceFVCode3D_ad07be7f9ed843ca65d02d0303dae6cb4}{dotProduct}(F\_permeability * normal, normal));
00212 
00213         \textcolor{keyword}{const} \hyperlink{namespaceFVCode3D_a40c1f5588a248569d80aa5f867080e83}{Real} alphaf = facet\_it.getSize() * KnDotF / Df;
00214 
00215         \textcolor{keyword}{const} \hyperlink{namespaceFVCode3D_a4bf7e328c75d0fd504050d040ebe9eda}{UInt} neighbor1id = facet\_it.getSeparatedCellsIds()[0];
00216         \textcolor{keyword}{const} \hyperlink{namespaceFVCode3D_a4bf7e328c75d0fd504050d040ebe9eda}{UInt} neighbor2id = facet\_it.getSeparatedCellsIds()[1];
00217 
00218         \textcolor{keyword}{const} \hyperlink{namespaceFVCode3D_a40c1f5588a248569d80aa5f867080e83}{Real} alpha1 = \hyperlink{classFVCode3D_1_1StiffMatrix_a2365673b4791819e78c4c593e2f63b28}{findAlpha}(neighbor1id, &facet\_it);
00219         \textcolor{keyword}{const} \hyperlink{namespaceFVCode3D_a40c1f5588a248569d80aa5f867080e83}{Real} alpha2 = \hyperlink{classFVCode3D_1_1StiffMatrix_a2365673b4791819e78c4c593e2f63b28}{findAlpha}(neighbor2id, &facet\_it);
00220 
00221         assert( alpha1 != 0 && alphaf != 0 );
00222         \textcolor{keyword}{const} \hyperlink{namespaceFVCode3D_a40c1f5588a248569d80aa5f867080e83}{Real} T1f = alpha1*alphaf/(alpha1 + alphaf);
00223         \textcolor{keyword}{const} \hyperlink{namespaceFVCode3D_a40c1f5588a248569d80aa5f867080e83}{Real} Q1f = T1f * \hyperlink{classFVCode3D_1_1MatrixHandler_ad17a7941b1b8272f50fc6e1c660103fa}{M\_properties}.\hyperlink{classFVCode3D_1_1PropertiesMap_a810ea62ca881e4db57acd601bcea23cf}{getMobility}();
00224 
00225         assert( alphaf != 0 && alpha2 != 0 );
00226         \textcolor{keyword}{const} \hyperlink{namespaceFVCode3D_a40c1f5588a248569d80aa5f867080e83}{Real} T2f = alphaf*alpha2/(alphaf + alpha2);
00227         \textcolor{keyword}{const} \hyperlink{namespaceFVCode3D_a40c1f5588a248569d80aa5f867080e83}{Real} Q2f = T2f * \hyperlink{classFVCode3D_1_1MatrixHandler_ad17a7941b1b8272f50fc6e1c660103fa}{M\_properties}.\hyperlink{classFVCode3D_1_1PropertiesMap_a810ea62ca881e4db57acd601bcea23cf}{getMobility}();
00228 
00229         \hyperlink{classFVCode3D_1_1MatrixHandler_a0bbdfb8d779ca20d8ba69b99cac1f4d6}{M\_matrixElements}.emplace\_back(\hyperlink{classFVCode3D_1_1MatrixHandler_ad3faa8b15bca6e0052be8c868b924444}{M\_offsetRow} + neighbor1id, 
      \hyperlink{classFVCode3D_1_1MatrixHandler_a6ec7cf5178c1c25b54abc46ff0affcf2}{M\_offsetCol} + neighbor1id, Q1f); \textcolor{comment}{// Triplet}
00230         \hyperlink{classFVCode3D_1_1MatrixHandler_a0bbdfb8d779ca20d8ba69b99cac1f4d6}{M\_matrixElements}.emplace\_back(\hyperlink{classFVCode3D_1_1MatrixHandler_ad3faa8b15bca6e0052be8c868b924444}{M\_offsetRow} + neighbor1id, 
      \hyperlink{classFVCode3D_1_1MatrixHandler_a6ec7cf5178c1c25b54abc46ff0affcf2}{M\_offsetCol} + facet\_it.getIdAsCell(), -Q1f); \textcolor{comment}{// Triplet}
00231         \hyperlink{classFVCode3D_1_1MatrixHandler_a0bbdfb8d779ca20d8ba69b99cac1f4d6}{M\_matrixElements}.emplace\_back(\hyperlink{classFVCode3D_1_1MatrixHandler_ad3faa8b15bca6e0052be8c868b924444}{M\_offsetRow} + facet\_it.getIdAsCell(), 
      \hyperlink{classFVCode3D_1_1MatrixHandler_a6ec7cf5178c1c25b54abc46ff0affcf2}{M\_offsetCol} + neighbor1id, -Q1f); \textcolor{comment}{// Triplet}
00232         \hyperlink{classFVCode3D_1_1MatrixHandler_a0bbdfb8d779ca20d8ba69b99cac1f4d6}{M\_matrixElements}.emplace\_back(\hyperlink{classFVCode3D_1_1MatrixHandler_ad3faa8b15bca6e0052be8c868b924444}{M\_offsetRow} + facet\_it.getIdAsCell(), 
      \hyperlink{classFVCode3D_1_1MatrixHandler_a6ec7cf5178c1c25b54abc46ff0affcf2}{M\_offsetCol} + facet\_it.getIdAsCell(), Q1f); \textcolor{comment}{// Triplet}
00233 
00234         \hyperlink{classFVCode3D_1_1MatrixHandler_a0bbdfb8d779ca20d8ba69b99cac1f4d6}{M\_matrixElements}.emplace\_back(\hyperlink{classFVCode3D_1_1MatrixHandler_ad3faa8b15bca6e0052be8c868b924444}{M\_offsetRow} + neighbor2id, 
      \hyperlink{classFVCode3D_1_1MatrixHandler_a6ec7cf5178c1c25b54abc46ff0affcf2}{M\_offsetCol} + neighbor2id, Q2f); \textcolor{comment}{// Triplet}
00235         \hyperlink{classFVCode3D_1_1MatrixHandler_a0bbdfb8d779ca20d8ba69b99cac1f4d6}{M\_matrixElements}.emplace\_back(\hyperlink{classFVCode3D_1_1MatrixHandler_ad3faa8b15bca6e0052be8c868b924444}{M\_offsetRow} + neighbor2id, 
      \hyperlink{classFVCode3D_1_1MatrixHandler_a6ec7cf5178c1c25b54abc46ff0affcf2}{M\_offsetCol} + facet\_it.getIdAsCell(), -Q2f); \textcolor{comment}{// Triplet}
00236         \hyperlink{classFVCode3D_1_1MatrixHandler_a0bbdfb8d779ca20d8ba69b99cac1f4d6}{M\_matrixElements}.emplace\_back(\hyperlink{classFVCode3D_1_1MatrixHandler_ad3faa8b15bca6e0052be8c868b924444}{M\_offsetRow} + facet\_it.getIdAsCell(), 
      \hyperlink{classFVCode3D_1_1MatrixHandler_a6ec7cf5178c1c25b54abc46ff0affcf2}{M\_offsetCol} + neighbor2id, -Q2f); \textcolor{comment}{// Triplet}
00237         \hyperlink{classFVCode3D_1_1MatrixHandler_a0bbdfb8d779ca20d8ba69b99cac1f4d6}{M\_matrixElements}.emplace\_back(\hyperlink{classFVCode3D_1_1MatrixHandler_ad3faa8b15bca6e0052be8c868b924444}{M\_offsetRow} + facet\_it.getIdAsCell(), 
      \hyperlink{classFVCode3D_1_1MatrixHandler_a6ec7cf5178c1c25b54abc46ff0affcf2}{M\_offsetCol} + facet\_it.getIdAsCell(), Q2f); \textcolor{comment}{// Triplet}
00238     \} \textcolor{comment}{// for}
00239 \} \textcolor{comment}{// StiffMatrix::assemblePorousMatrix}
00240 
\hypertarget{Stiffness_8cpp_source.tex_l00241}{}\hyperlink{classFVCode3D_1_1StiffMatrix_aee24f1b77e66c0bb7be4efbf43671c44}{00241} \textcolor{keywordtype}{void} \hyperlink{classFVCode3D_1_1StiffMatrix_aee24f1b77e66c0bb7be4efbf43671c44}{StiffMatrix::assemblePorousMatrixBC}()
00242 \{
00243     \textcolor{keywordflow}{for} (\textcolor{keyword}{auto}& facet\_it : this->\hyperlink{classFVCode3D_1_1MatrixHandler_a72f185cb557fc2e8023bd09a074f685c}{M\_mesh}.\hyperlink{classFVCode3D_1_1Rigid__Mesh_aa72b7fad937f0d1586fc10b176ef5d3e}{getBorderFacetsIdsVector}())
00244     \{
00245         \textcolor{keyword}{const} \hyperlink{namespaceFVCode3D_a4bf7e328c75d0fd504050d040ebe9eda}{UInt} neighbor1id = facet\_it.getSeparatedCellsIds()[0];
00246         \textcolor{keyword}{const} \hyperlink{namespaceFVCode3D_a4bf7e328c75d0fd504050d040ebe9eda}{UInt} borderId = facet\_it.getBorderId();
00247 
00248         \textcolor{keywordflow}{if}(\hyperlink{classFVCode3D_1_1StiffMatrix_a23e3ffc97fcf112958e9966cac41e9d3}{M\_bc}.\hyperlink{classFVCode3D_1_1BoundaryConditions_a5b53a81bdab88709fae14892bfe6a7c9}{getBordersBCMap}().at(borderId).getBCType() == 
      \hyperlink{namespaceFVCode3D_a73660061f11f1671164ce171a053f8c5a30212425b27314b01b40f4984dbf850a}{Neumann} )
00249         \{
00250             \textcolor{comment}{// Nella cond di bordo c'è già il contributo della permeabilità e mobilità (ma non la densità!)}
00251             \textcolor{keyword}{const} \hyperlink{namespaceFVCode3D_a40c1f5588a248569d80aa5f867080e83}{Real} Q1o = \hyperlink{classFVCode3D_1_1StiffMatrix_a23e3ffc97fcf112958e9966cac41e9d3}{M\_bc}.\hyperlink{classFVCode3D_1_1BoundaryConditions_a5b53a81bdab88709fae14892bfe6a7c9}{getBordersBCMap}().at(borderId).getBC()(facet\_it.
      getCentroid()) * facet\_it.getSize();
00252 
00253             \hyperlink{classFVCode3D_1_1StiffMatrix_a5bbfb34d8ef115d2806d5ded5ff109d0}{M\_b}->operator()(\hyperlink{classFVCode3D_1_1MatrixHandler_ad3faa8b15bca6e0052be8c868b924444}{M\_offsetRow} + neighbor1id) -= Q1o;
00254         \} \textcolor{comment}{// if}
00255         \textcolor{keywordflow}{else} \textcolor{keywordflow}{if}(\hyperlink{classFVCode3D_1_1StiffMatrix_a23e3ffc97fcf112958e9966cac41e9d3}{M\_bc}.\hyperlink{classFVCode3D_1_1BoundaryConditions_a5b53a81bdab88709fae14892bfe6a7c9}{getBordersBCMap}().at(borderId).getBCType() == 
      \hyperlink{namespaceFVCode3D_a73660061f11f1671164ce171a053f8c5a192024697bdaa4fbbb39b8961b747bce}{Dirichlet})
00256         \{
00257             \textcolor{keyword}{const} \hyperlink{namespaceFVCode3D_a40c1f5588a248569d80aa5f867080e83}{Real} alpha1 = \hyperlink{classFVCode3D_1_1StiffMatrix_a2365673b4791819e78c4c593e2f63b28}{findAlpha} (neighbor1id, &facet\_it);
00258             \textcolor{keyword}{const} \hyperlink{namespaceFVCode3D_a40c1f5588a248569d80aa5f867080e83}{Real} alpha2 = \hyperlink{classFVCode3D_1_1StiffMatrix_aec36126e4870fc3f94a2d36b831c739e}{findDirichletAlpha} (neighbor1id, &facet\_it);
00259 
00260             assert( alpha1 != 0 && alpha2 != 0 );
00261             \textcolor{keyword}{const} \hyperlink{namespaceFVCode3D_a40c1f5588a248569d80aa5f867080e83}{Real} T12 = 2 * alpha1*alpha2/(alpha1 + alpha2);
00262             \textcolor{keyword}{const} \hyperlink{namespaceFVCode3D_a40c1f5588a248569d80aa5f867080e83}{Real} Q12 = T12 * \hyperlink{classFVCode3D_1_1MatrixHandler_ad17a7941b1b8272f50fc6e1c660103fa}{M\_properties}.\hyperlink{classFVCode3D_1_1PropertiesMap_a810ea62ca881e4db57acd601bcea23cf}{getMobility}();
00263             \textcolor{keyword}{const} \hyperlink{namespaceFVCode3D_a40c1f5588a248569d80aa5f867080e83}{Real} Q1o = Q12 * \hyperlink{classFVCode3D_1_1StiffMatrix_a23e3ffc97fcf112958e9966cac41e9d3}{M\_bc}.\hyperlink{classFVCode3D_1_1BoundaryConditions_a5b53a81bdab88709fae14892bfe6a7c9}{getBordersBCMap}().at(borderId).getBC()(
      facet\_it.getCentroid());
00264 
00265             \hyperlink{classFVCode3D_1_1MatrixHandler_a0bbdfb8d779ca20d8ba69b99cac1f4d6}{M\_matrixElements}.emplace\_back(\hyperlink{classFVCode3D_1_1MatrixHandler_ad3faa8b15bca6e0052be8c868b924444}{M\_offsetRow} + neighbor1id, 
      \hyperlink{classFVCode3D_1_1MatrixHandler_a6ec7cf5178c1c25b54abc46ff0affcf2}{M\_offsetCol} + neighbor1id, Q12); \textcolor{comment}{// Triplet}
00266             \hyperlink{classFVCode3D_1_1StiffMatrix_a5bbfb34d8ef115d2806d5ded5ff109d0}{M\_b}->operator()(\hyperlink{classFVCode3D_1_1MatrixHandler_ad3faa8b15bca6e0052be8c868b924444}{M\_offsetRow} + neighbor1id) += Q1o;
00267         \} \textcolor{comment}{// else if}
00268     \} \textcolor{comment}{// for}
00269 \} \textcolor{comment}{// StiffMatrix::assemblePorousMatrixBC}
00270 
\hypertarget{Stiffness_8cpp_source.tex_l00271}{}\hyperlink{classFVCode3D_1_1StiffMatrix_a14fa2721385e2cc9c0c179c2cff6e618}{00271} \textcolor{keywordtype}{void} \hyperlink{classFVCode3D_1_1StiffMatrix_a14fa2721385e2cc9c0c179c2cff6e618}{StiffMatrix::assembleFracture}()
00272 \{
00273     \textcolor{keywordflow}{for}(\textcolor{keyword}{auto}& facet\_it : this->\hyperlink{classFVCode3D_1_1MatrixHandler_a72f185cb557fc2e8023bd09a074f685c}{M\_mesh}.\hyperlink{classFVCode3D_1_1Rigid__Mesh_aadbe6d9ad704122537903396d91238e0}{getFractureFacetsIdsVector}())
00274     \{
00275         \textcolor{keywordflow}{for}(\textcolor{keyword}{auto}& juncture\_it : facet\_it.getFractureNeighbors())
00276         \{
00277             std::vector<Real> alphas;
00278             \textcolor{keyword}{const} \hyperlink{namespaceFVCode3D_a40c1f5588a248569d80aa5f867080e83}{Real} alphaF = \hyperlink{classFVCode3D_1_1StiffMatrix_a53ce514c7a4c784061b5339350e00995}{findFracturesAlpha}(juncture\_it.first, facet\_it.
      getFractureId());
00279 
00280             \textcolor{keywordflow}{for}(\textcolor{keyword}{auto} neighbors\_it : juncture\_it.second)
00281             \{
00282                 alphas.emplace\_back(\hyperlink{classFVCode3D_1_1StiffMatrix_a53ce514c7a4c784061b5339350e00995}{findFracturesAlpha}(juncture\_it.first, neighbors\_it));
00283             \} \textcolor{comment}{// for}
00284 
00285             \hyperlink{namespaceFVCode3D_a40c1f5588a248569d80aa5f867080e83}{Real} a\_sum = alphaF;
00286             \textcolor{keyword}{auto} sum\_maker = [&a\_sum](\hyperlink{namespaceFVCode3D_a40c1f5588a248569d80aa5f867080e83}{Real} item)\{a\_sum += item;\};
00287             std::for\_each(alphas.begin(), alphas.end(), sum\_maker);
00288 
00289             assert( a\_sum != 0 );
00290 
00291             \textcolor{keywordflow}{for}(\hyperlink{namespaceFVCode3D_a4bf7e328c75d0fd504050d040ebe9eda}{UInt} counter = 0; counter < alphas.size(); ++counter)
00292             \{
00293                 \textcolor{keyword}{const} \hyperlink{namespaceFVCode3D_a40c1f5588a248569d80aa5f867080e83}{Real} QFf = alphaF * alphas[counter] * \hyperlink{classFVCode3D_1_1MatrixHandler_ad17a7941b1b8272f50fc6e1c660103fa}{M\_properties}.
      \hyperlink{classFVCode3D_1_1PropertiesMap_a810ea62ca881e4db57acd601bcea23cf}{getMobility}() / a\_sum;
00294                 \hyperlink{classFVCode3D_1_1MatrixHandler_a0bbdfb8d779ca20d8ba69b99cac1f4d6}{M\_matrixElements}.emplace\_back(\hyperlink{classFVCode3D_1_1MatrixHandler_ad3faa8b15bca6e0052be8c868b924444}{M\_offsetRow} + facet\_it.getIdAsCell
      (), \hyperlink{classFVCode3D_1_1MatrixHandler_a6ec7cf5178c1c25b54abc46ff0affcf2}{M\_offsetCol} + facet\_it.getIdAsCell(), QFf); \textcolor{comment}{// Triplet}
00295                 \hyperlink{classFVCode3D_1_1MatrixHandler_a0bbdfb8d779ca20d8ba69b99cac1f4d6}{M\_matrixElements}.emplace\_back(\hyperlink{classFVCode3D_1_1MatrixHandler_ad3faa8b15bca6e0052be8c868b924444}{M\_offsetRow} + facet\_it.getIdAsCell
      (),
00296                     \hyperlink{classFVCode3D_1_1MatrixHandler_a6ec7cf5178c1c25b54abc46ff0affcf2}{M\_offsetCol} + this->\hyperlink{classFVCode3D_1_1MatrixHandler_a72f185cb557fc2e8023bd09a074f685c}{M\_mesh}.
      \hyperlink{classFVCode3D_1_1Rigid__Mesh_aadbe6d9ad704122537903396d91238e0}{getFractureFacetsIdsVector}()[juncture\_it.second[counter]].getIdAsCell(),
00297                     -QFf);  \textcolor{comment}{// Triplet}
00298             \} \textcolor{comment}{// for}
00299         \} \textcolor{comment}{// for}
00300     \} \textcolor{comment}{// for}
00301 \} \textcolor{comment}{// StiffMatrix::assembleFracture}
00302 
\hypertarget{Stiffness_8cpp_source.tex_l00303}{}\hyperlink{classFVCode3D_1_1StiffMatrix_af7e80d2641fc41174eb4cb56e2f119d4}{00303} \textcolor{keywordtype}{void} \hyperlink{classFVCode3D_1_1StiffMatrix_af7e80d2641fc41174eb4cb56e2f119d4}{StiffMatrix::assembleFractureBC}()
00304 \{
00305     \textcolor{keywordflow}{for} (\textcolor{keyword}{auto}& edge\_it : this->\hyperlink{classFVCode3D_1_1MatrixHandler_a72f185cb557fc2e8023bd09a074f685c}{M\_mesh}.\hyperlink{classFVCode3D_1_1Rigid__Mesh_a12c92b683cfb3d9ac2645f038a8c6220}{getBorderTipEdgesIdsVector}())
00306     \{
00307         \textcolor{keywordtype}{bool} isD = \textcolor{keyword}{false};
00308         \hyperlink{namespaceFVCode3D_a4bf7e328c75d0fd504050d040ebe9eda}{UInt} borderId = 0;
00309 
00310         \textcolor{comment}{// select which BC to apply}
00311         \textcolor{keywordflow}{for}(\textcolor{keyword}{auto} border\_it : edge\_it.getBorderIds())
00312         \{
00313             \textcolor{comment}{// BC = D > N && the one with greatest id}
00314             \textcolor{keywordflow}{if}(\hyperlink{classFVCode3D_1_1StiffMatrix_a23e3ffc97fcf112958e9966cac41e9d3}{M\_bc}.\hyperlink{classFVCode3D_1_1BoundaryConditions_a5b53a81bdab88709fae14892bfe6a7c9}{getBordersBCMap}().at(border\_it).getBCType() == 
      \hyperlink{namespaceFVCode3D_a73660061f11f1671164ce171a053f8c5a192024697bdaa4fbbb39b8961b747bce}{Dirichlet})
00315             \{
00316                 \textcolor{keywordflow}{if}(!isD)
00317                 \{
00318                     isD = \textcolor{keyword}{true};
00319                     borderId = border\_it;
00320                 \}
00321                 \textcolor{keywordflow}{else}
00322                 \{
00323                     borderId = (border\_it > borderId) ? border\_it : borderId;
00324                 \}
00325             \}
00326             \textcolor{keywordflow}{else} \textcolor{keywordflow}{if}(!isD && \hyperlink{classFVCode3D_1_1StiffMatrix_a23e3ffc97fcf112958e9966cac41e9d3}{M\_bc}.\hyperlink{classFVCode3D_1_1BoundaryConditions_a5b53a81bdab88709fae14892bfe6a7c9}{getBordersBCMap}().at(border\_it).getBCType() == 
      \hyperlink{namespaceFVCode3D_a73660061f11f1671164ce171a053f8c5a30212425b27314b01b40f4984dbf850a}{Neumann})
00327             \{
00328                 borderId = (border\_it > borderId) ? border\_it : borderId;
00329             \}
00330         \}
00331 
00332         \textcolor{comment}{// loop over the fracture facets}
00333         \textcolor{keywordflow}{for}(\textcolor{keyword}{auto} facet\_it : edge\_it.getSeparatedFacetsIds())
00334         \{
00335             \textcolor{keywordflow}{if}(this->\hyperlink{classFVCode3D_1_1MatrixHandler_a72f185cb557fc2e8023bd09a074f685c}{M\_mesh}.\hyperlink{classFVCode3D_1_1Rigid__Mesh_a6d3cdd4ef8a5225599953179d5302636}{getFacetsVector}()[facet\_it].isFracture())
00336             \{
00337                 \textcolor{keyword}{const} \hyperlink{namespaceFVCode3D_a4bf7e328c75d0fd504050d040ebe9eda}{UInt} neighborIdAsCell = \hyperlink{classFVCode3D_1_1MatrixHandler_a72f185cb557fc2e8023bd09a074f685c}{M\_mesh}.\hyperlink{classFVCode3D_1_1Rigid__Mesh_a6d3cdd4ef8a5225599953179d5302636}{getFacetsVector}()[facet\_it].
      getFractureFacetId() + \hyperlink{classFVCode3D_1_1MatrixHandler_a72f185cb557fc2e8023bd09a074f685c}{M\_mesh}.\hyperlink{classFVCode3D_1_1Rigid__Mesh_afefb62f2c37317402b495e2369ed495b}{getCellsVector}().size();
00338                 \textcolor{keyword}{const} \hyperlink{namespaceFVCode3D_a40c1f5588a248569d80aa5f867080e83}{Real} aperture = \hyperlink{classFVCode3D_1_1MatrixHandler_ad17a7941b1b8272f50fc6e1c660103fa}{M\_properties}.\hyperlink{classFVCode3D_1_1PropertiesMap_ace888d15c9a4ab13d5e217a3a565604c}{getProperties}(this->
      \hyperlink{classFVCode3D_1_1MatrixHandler_a72f185cb557fc2e8023bd09a074f685c}{M\_mesh}.\hyperlink{classFVCode3D_1_1Rigid__Mesh_a6d3cdd4ef8a5225599953179d5302636}{getFacetsVector}()[facet\_it].getZoneCode()).M\_aperture;
00339 
00340                 \textcolor{keywordflow}{if}(\hyperlink{classFVCode3D_1_1StiffMatrix_a23e3ffc97fcf112958e9966cac41e9d3}{M\_bc}.\hyperlink{classFVCode3D_1_1BoundaryConditions_a5b53a81bdab88709fae14892bfe6a7c9}{getBordersBCMap}().at(borderId).getBCType() == 
      \hyperlink{namespaceFVCode3D_a73660061f11f1671164ce171a053f8c5a30212425b27314b01b40f4984dbf850a}{Neumann})
00341                 \{
00342                     \textcolor{comment}{// Nella cond di bordo c'è già il contributo della permeabilità e mobilità (ma non la
       densità!)}
00343                     \textcolor{keyword}{const} \hyperlink{namespaceFVCode3D_a40c1f5588a248569d80aa5f867080e83}{Real} Q1o = \hyperlink{classFVCode3D_1_1StiffMatrix_a23e3ffc97fcf112958e9966cac41e9d3}{M\_bc}.\hyperlink{classFVCode3D_1_1BoundaryConditions_a5b53a81bdab88709fae14892bfe6a7c9}{getBordersBCMap}().at(borderId).getBC()(
      edge\_it.getCentroid()) * edge\_it.getSize() * aperture;
00344 
00345                     \hyperlink{classFVCode3D_1_1StiffMatrix_a5bbfb34d8ef115d2806d5ded5ff109d0}{M\_b}->operator()(\hyperlink{classFVCode3D_1_1MatrixHandler_ad3faa8b15bca6e0052be8c868b924444}{M\_offsetRow} + neighborIdAsCell) -= Q1o;
00346                 \} \textcolor{comment}{// if}
00347                 \textcolor{keywordflow}{else} \textcolor{keywordflow}{if}(\hyperlink{classFVCode3D_1_1StiffMatrix_a23e3ffc97fcf112958e9966cac41e9d3}{M\_bc}.\hyperlink{classFVCode3D_1_1BoundaryConditions_a5b53a81bdab88709fae14892bfe6a7c9}{getBordersBCMap}().at(borderId).getBCType() == 
      \hyperlink{namespaceFVCode3D_a73660061f11f1671164ce171a053f8c5a192024697bdaa4fbbb39b8961b747bce}{Dirichlet})
00348                 \{
00349                     \textcolor{keyword}{const} \hyperlink{namespaceFVCode3D_a40c1f5588a248569d80aa5f867080e83}{Real} alpha1 = \hyperlink{classFVCode3D_1_1StiffMatrix_a2365673b4791819e78c4c593e2f63b28}{findAlpha} (facet\_it, &edge\_it);
00350                     \textcolor{keyword}{const} \hyperlink{namespaceFVCode3D_a40c1f5588a248569d80aa5f867080e83}{Real} alpha2 = \hyperlink{classFVCode3D_1_1StiffMatrix_aec36126e4870fc3f94a2d36b831c739e}{findDirichletAlpha} (facet\_it, &edge\_it);
00351 
00352                     assert( alpha1 != 0 && alpha2 != 0 );
00353                     \textcolor{keyword}{const} \hyperlink{namespaceFVCode3D_a40c1f5588a248569d80aa5f867080e83}{Real} T12 = 2 * alpha1*alpha2/(alpha1 + alpha2);
00354                     \textcolor{keyword}{const} \hyperlink{namespaceFVCode3D_a40c1f5588a248569d80aa5f867080e83}{Real} Q12 = T12 * \hyperlink{classFVCode3D_1_1MatrixHandler_ad17a7941b1b8272f50fc6e1c660103fa}{M\_properties}.
      \hyperlink{classFVCode3D_1_1PropertiesMap_a810ea62ca881e4db57acd601bcea23cf}{getMobility}();
00355                     \textcolor{keyword}{const} \hyperlink{namespaceFVCode3D_a40c1f5588a248569d80aa5f867080e83}{Real} Q1o = Q12 * \hyperlink{classFVCode3D_1_1StiffMatrix_a23e3ffc97fcf112958e9966cac41e9d3}{M\_bc}.\hyperlink{classFVCode3D_1_1BoundaryConditions_a5b53a81bdab88709fae14892bfe6a7c9}{getBordersBCMap}().at(borderId).getBC
      ()(edge\_it.getCentroid());
00356 
00357                     \hyperlink{classFVCode3D_1_1MatrixHandler_a0bbdfb8d779ca20d8ba69b99cac1f4d6}{M\_matrixElements}.emplace\_back(\hyperlink{classFVCode3D_1_1MatrixHandler_ad3faa8b15bca6e0052be8c868b924444}{M\_offsetRow} + neighborIdAsCell
      , \hyperlink{classFVCode3D_1_1MatrixHandler_a6ec7cf5178c1c25b54abc46ff0affcf2}{M\_offsetCol} + neighborIdAsCell, Q12); \textcolor{comment}{// Triplet}
00358                     \hyperlink{classFVCode3D_1_1StiffMatrix_a5bbfb34d8ef115d2806d5ded5ff109d0}{M\_b}->operator()(\hyperlink{classFVCode3D_1_1MatrixHandler_ad3faa8b15bca6e0052be8c868b924444}{M\_offsetRow} + neighborIdAsCell) += Q1o;
00359                 \} \textcolor{comment}{// else if}
00360             \} \textcolor{comment}{// if}
00361         \}\textcolor{comment}{// for}
00362     \} \textcolor{comment}{// for}
00363 \} \textcolor{comment}{// StiffMatrix::assembleFractureBC}
00364 
\hypertarget{Stiffness_8cpp_source.tex_l00365}{}\hyperlink{classFVCode3D_1_1StiffMatrix_ac3eb491563c1742f4adba021e397719b}{00365} \textcolor{keywordtype}{void} \hyperlink{classFVCode3D_1_1StiffMatrix_ac3eb491563c1742f4adba021e397719b}{StiffMatrix::assembleMFD}()
00366 \{
00367     std::cout<<std::endl;
00368     \textcolor{keyword}{using} Eigen::Dynamic;
00369     \textcolor{keyword}{using} Eigen::RowMajor;
00370     \textcolor{keyword}{using} Eigen::ColMajor;
00371     
00372     \textcolor{comment}{// Extract info of mesh. auto&& resolves const &}
00373     \textcolor{keyword}{auto}& cellVectorRef    = this->\hyperlink{classFVCode3D_1_1MatrixHandler_a72f185cb557fc2e8023bd09a074f685c}{M\_mesh}.\hyperlink{classFVCode3D_1_1Rigid__Mesh_afefb62f2c37317402b495e2369ed495b}{getCellsVector}();
00374     \textcolor{keyword}{auto}& facetVectorRef   = this->\hyperlink{classFVCode3D_1_1MatrixHandler_a72f185cb557fc2e8023bd09a074f685c}{M\_mesh}.\hyperlink{classFVCode3D_1_1Rigid__Mesh_a6d3cdd4ef8a5225599953179d5302636}{getFacetsVector}();
00375     \textcolor{keyword}{auto}& fracVectorRef    = this->\hyperlink{classFVCode3D_1_1MatrixHandler_a72f185cb557fc2e8023bd09a074f685c}{M\_mesh}.\hyperlink{classFVCode3D_1_1Rigid__Mesh_aadbe6d9ad704122537903396d91238e0}{getFractureFacetsIdsVector}();
00376     \textcolor{keyword}{const} \hyperlink{namespaceFVCode3D_a4bf7e328c75d0fd504050d040ebe9eda}{UInt} numFacets        = facetVectorRef.size();
00377     \textcolor{keyword}{const} \hyperlink{namespaceFVCode3D_a4bf7e328c75d0fd504050d040ebe9eda}{UInt} numCells         = cellVectorRef.size();
00378     \textcolor{keyword}{const} \hyperlink{namespaceFVCode3D_a4bf7e328c75d0fd504050d040ebe9eda}{UInt} numFracs         = fracVectorRef.size();
00379     \textcolor{keyword}{const} \hyperlink{namespaceFVCode3D_a4bf7e328c75d0fd504050d040ebe9eda}{UInt} numFacetsTot     = numFacets + numFracs;
00380     \textcolor{keyword}{const} \hyperlink{namespaceFVCode3D_a4bf7e328c75d0fd504050d040ebe9eda}{UInt} numCellsTot      = numCells + numFracs;
00381     \textcolor{keyword}{const} \hyperlink{namespaceFVCode3D_a4bf7e328c75d0fd504050d040ebe9eda}{UInt} numGDL           = numFacetsTot + numCellsTot;
00382 
00383     \textcolor{comment}{// Define global matrix and vector to reserve space}
00384     Eigen::VectorXd & rhs                       = *(this->\hyperlink{classFVCode3D_1_1StiffMatrix_a5bbfb34d8ef115d2806d5ded5ff109d0}{M\_b});         \textcolor{comment}{// rhs  }
00385     Eigen::SparseMatrix<Real,ColMajor> & S      = *(this->\hyperlink{classFVCode3D_1_1MatrixHandler_ae266bd543d9369501ed9317d9ba6a07b}{M\_Matrix});    \textcolor{comment}{// global matrix}
00386     std::vector<UInt> Matrix\_elements(numGDL,0);                        \textcolor{comment}{// vector to reserve space}
00387     
00388     \textcolor{comment}{// Problem coefficients}
00389     \textcolor{keyword}{const} \hyperlink{namespaceFVCode3D_a40c1f5588a248569d80aa5f867080e83}{Real} tCoeff     = 2.;                            \textcolor{comment}{// mimetic coefficient         }
00390     \textcolor{keyword}{const} \hyperlink{namespaceFVCode3D_a40c1f5588a248569d80aa5f867080e83}{Real} xsi        = 1;                             \textcolor{comment}{// coupling coefficient}
00391     \textcolor{keyword}{const} \hyperlink{namespaceFVCode3D_a40c1f5588a248569d80aa5f867080e83}{Real} xsi0       = ( 2. * xsi - 1. ) / 4.;        \textcolor{comment}{// coupling modified coefficient}
00392 
00393     \textcolor{comment}{// Local MFD matrices}
00394     Eigen::Matrix<Real,Dynamic,3> Np;         \textcolor{comment}{// facet normals, necessary to build Mp}
00395     Eigen::Matrix<Real,3,3> Kp;               \textcolor{comment}{// permability tensor}
00396     Eigen::Matrix<Real,1,Dynamic> Bp;         \textcolor{comment}{// local B}
00397     Eigen::Matrix<Real,Dynamic,3> Rp;         \textcolor{comment}{// centroid * area, necessary to build Mp}
00398     Eigen::Matrix<Real,Dynamic,Dynamic> M0p;  \textcolor{comment}{// Component of local M matrix (consistency)}
00399     Eigen::Matrix<Real,Dynamic,Dynamic> M1p;  \textcolor{comment}{// Component of local M Matrix (stability)}
00400     Eigen::Matrix<Real,Dynamic,Dynamic> Mp;   \textcolor{comment}{// local M matrix for internal product}
00401     Eigen::Matrix<Real,Dynamic,Dynamic> Sp;   \textcolor{comment}{// Base for the column space of Np}
00402 
00403 
00404     \textcolor{comment}{// First loop to size matrices and avoid memory realloc}
00405     \textcolor{keywordflow}{for} (\textcolor{keyword}{auto}& cell : cellVectorRef)\{
00406                 
00407         \textcolor{keyword}{const} std::vector<UInt> & cellFacetsId( cell.getFacetsIds() );
00408         \hyperlink{namespaceFVCode3D_a4bf7e328c75d0fd504050d040ebe9eda}{UInt} numCellFacets = cellFacetsId.size();
00409         \hyperlink{namespaceFVCode3D_a4bf7e328c75d0fd504050d040ebe9eda}{UInt} cellId        = cell.getId();
00410 
00411         \textcolor{keywordflow}{for}(\hyperlink{namespaceFVCode3D_a4bf7e328c75d0fd504050d040ebe9eda}{UInt} localFacetId=0; localFacetId<numCellFacets; ++localFacetId)\{       
00412                         
00413                         \hyperlink{namespaceFVCode3D_a4bf7e328c75d0fd504050d040ebe9eda}{UInt} globalFacetId = cellFacetsId[localFacetId];
00414                         \textcolor{keyword}{const} \hyperlink{classFVCode3D_1_1Rigid__Mesh_1_1Facet}{Rigid\_Mesh::Facet} & fac = facetVectorRef[globalFacetId];
00415                         
00416                         \textcolor{comment}{// This is to take into account the decoupling of fractures facets}
00417                         \textcolor{keywordflow}{if}( fac.\hyperlink{classFVCode3D_1_1Rigid__Mesh_1_1Facet_aed3f579d52847e839501f647e90c35ab}{isFracture}() && (cell.orientationFacet(fac)<0) )
00418                                         globalFacetId = numFacets + fac.
      \hyperlink{classFVCode3D_1_1Rigid__Mesh_1_1Facet_a08dc369eccd02b29133187cede7511eb}{getFractureFacetId}();
00419 
00420                         Matrix\_elements[globalFacetId] += numCellFacets + 1;        \textcolor{comment}{// numCellFacets for
       the M, the 1 for the B}
00421 
00422             Matrix\_elements[numFacetsTot + cellId] += 1;                \textcolor{comment}{// this is for the Bt}
00423             
00424         \}
00425     \}
00426     
00427     S.reserve(Matrix\_elements);
00428 
00429     \textcolor{comment}{// Loop on cells to build MFD local matrices and assemble them in MFD global matrices}
00430     \textcolor{keywordflow}{for} (\textcolor{keyword}{auto}& cell : cellVectorRef)\{
00431                 
00432         \textcolor{keyword}{const} std::vector<UInt> & cellFacetsId( cell.getFacetsIds() );
00433         \textcolor{keyword}{const} \hyperlink{namespaceFVCode3D_a4bf7e328c75d0fd504050d040ebe9eda}{UInt} numCellFacets  = cellFacetsId.size();
00434         \textcolor{keyword}{auto}& K = \hyperlink{classFVCode3D_1_1MatrixHandler_ad17a7941b1b8272f50fc6e1c660103fa}{M\_properties}.\hyperlink{classFVCode3D_1_1PropertiesMap_ace888d15c9a4ab13d5e217a3a565604c}{getProperties}(cell.getZoneCode()).M\_permeability;
00435         \textcolor{keyword}{const} \hyperlink{namespaceFVCode3D_a40c1f5588a248569d80aa5f867080e83}{Real} cellMeasure    = cell.getVolume();
00436         \textcolor{keyword}{const} \hyperlink{namespaceFVCode3D_a4bf7e328c75d0fd504050d040ebe9eda}{UInt} cellId         = cell.getId();
00437 
00438         \textcolor{keywordflow}{if}(cellId % 500 == 0)
00439             std::cout<<\textcolor{stringliteral}{"Done "}<< cellId<<\textcolor{stringliteral}{" Cells"}<<std::endl;
00440 
00441         \textcolor{comment}{// Resize local matrices}
00442         Np.resize(numCellFacets,Eigen::NoChange);
00443         Np.setZero();
00444         Rp.resize(numCellFacets,Eigen::NoChange);
00445         Rp.setZero();
00446         Bp.resize(Eigen::NoChange,numCellFacets);
00447         Bp.setZero();
00448 
00449         Kp(0,0) = K->operator()(0,0);
00450         Kp(0,1) = K->operator()(0,1);
00451         Kp(0,2) = K->operator()(0,2);
00452         Kp(1,0) = K->operator()(1,0);
00453         Kp(1,1) = K->operator()(1,1);
00454         Kp(1,2) = K->operator()(1,2);
00455         Kp(2,0) = K->operator()(2,0);
00456         Kp(2,1) = K->operator()(2,1);
00457         Kp(2,2) = K->operator()(2,2);
00458 
00459                 \textcolor{comment}{// Loop on facets to build Rp, Np, Bp, Dtp}
00460         \textcolor{keywordflow}{for}(\hyperlink{namespaceFVCode3D_a4bf7e328c75d0fd504050d040ebe9eda}{UInt} localFacetId=0; localFacetId<numCellFacets; ++localFacetId)\{
00461                         
00462             \textcolor{keyword}{const} \hyperlink{namespaceFVCode3D_a4bf7e328c75d0fd504050d040ebe9eda}{UInt} globalFacetId = cellFacetsId[localFacetId];
00463             \textcolor{keyword}{const} \hyperlink{classFVCode3D_1_1Rigid__Mesh_1_1Facet}{Rigid\_Mesh::Facet} & fac = facetVectorRef[globalFacetId];
00464 
00465                         \textcolor{keyword}{const} \hyperlink{classFVCode3D_1_1Point3D}{Point3D} facetNormal     = fac.
      \hyperlink{classFVCode3D_1_1Rigid__Mesh_1_1Facet_ae8d74e38b74075a3ced8b1a229860120}{getUnsignedNormal}();
00466             \hyperlink{classFVCode3D_1_1Point3D}{Point3D} g                     = fac.\hyperlink{classFVCode3D_1_1Rigid__Mesh_1_1Facet_a0d4bcc392ef3da56ccdb40c22b6319e3}{getCentroid}() - cell.getCentroid();
00467             \textcolor{keyword}{const} \hyperlink{namespaceFVCode3D_a40c1f5588a248569d80aa5f867080e83}{Real} facetMeasure       = fac.\hyperlink{classFVCode3D_1_1Rigid__Mesh_1_1Facet_a19b2922eb0458019c8f34b40f0517789}{area}();
00468             \textcolor{keyword}{const} \hyperlink{namespaceFVCode3D_a40c1f5588a248569d80aa5f867080e83}{Real} alpha              = cell.orientationFacet(fac);
00469             
00471             \textcolor{comment}{// BEWARE FOR THE CONDITION ON VELOCITY I NEED THE AVERAGE}
00472             \textcolor{comment}{// VELOCITY NOT THE FLUX}
00473             Np(localFacetId,0) = facetNormal[0];
00474             Np(localFacetId,1) = facetNormal[1];
00475             Np(localFacetId,2) = facetNormal[2];
00476             Np *= Kp;
00477 
00478             Bp(0,localFacetId) =  - alpha * facetMeasure;    \textcolor{comment}{// The minus because I have changed the sign
       to the conservation equation}
00479 
00480             g[0] = std::fabs(g[0]) < 1e-15 ? 0 : g[0]; \textcolor{comment}{// TODO set relative eps}
00481             g[1] = std::fabs(g[1]) < 1e-15 ? 0 : g[1]; \textcolor{comment}{// TODO set relative eps}
00482             g[2] = std::fabs(g[2]) < 1e-15 ? 0 : g[2]; \textcolor{comment}{// TODO set relative eps}
00483 
00484             Rp(localFacetId,0) = alpha * g[0] * facetMeasure;
00485             Rp(localFacetId,1) = alpha * g[1] * facetMeasure;
00486             Rp(localFacetId,2) = alpha * g[2] * facetMeasure;
00487 
00488             \textcolor{keywordflow}{if} (fac.\hyperlink{classFVCode3D_1_1Rigid__Mesh_1_1Facet_af84dc398fca7867ff763bfca119ddc16}{isBorderFacet}() && (\hyperlink{classFVCode3D_1_1StiffMatrix_a23e3ffc97fcf112958e9966cac41e9d3}{M\_bc}.\hyperlink{classFVCode3D_1_1BoundaryConditions_a5b53a81bdab88709fae14892bfe6a7c9}{getBordersBCMap}().at(fac.
      \hyperlink{classFVCode3D_1_1Rigid__Mesh_1_1Facet_a528828e73f43ae6fa5c858ecc5ab5a65}{getBorderId}()).getBCType() == \hyperlink{namespaceFVCode3D_a73660061f11f1671164ce171a053f8c5a192024697bdaa4fbbb39b8961b747bce}{Dirichlet}))
00489                 rhs[globalFacetId] = - alpha * facetMeasure;
00490 
00491         \}
00492 
00493                 \textcolor{comment}{// Building the Mp matrix}
00494         Sp = Np.fullPivLu().image(Np);    \textcolor{comment}{// Because otherwise NtN could be singulare in the unlucky case
       of 2 parallelel faces}
00495 
00496         Eigen::Matrix<Real,Dynamic,Dynamic> NtN = Sp.transpose() * Sp;
00497         Eigen::Matrix<Real,Dynamic,Dynamic> NNtNiNt = Sp * NtN.inverse() * Sp.transpose();
00498 
00499         M0p.resize(numCellFacets,numCellFacets);
00500         M0p.setZero();
00501         M1p.resize(numCellFacets,numCellFacets);
00502         M1p.setZero();
00503         Mp.resize(numCellFacets,numCellFacets);
00504         Mp.setZero();
00505 
00506         M0p = ( 1. / cellMeasure ) *
00507               (Rp * Kp.inverse() * Rp.transpose());
00508         M1p = M0p.trace() * tCoeff / numCellFacets *
00509               ( Eigen::MatrixXd::Identity(numCellFacets,numCellFacets) -
00510                 NNtNiNt
00511               );
00512 
00513         Mp  = M0p + M1p;
00514 
00515 
00516         \textcolor{keywordflow}{for}(\hyperlink{namespaceFVCode3D_a4bf7e328c75d0fd504050d040ebe9eda}{UInt} iloc=0; iloc<numCellFacets; ++iloc)\{
00517                         
00518             \hyperlink{namespaceFVCode3D_a4bf7e328c75d0fd504050d040ebe9eda}{UInt} i = cellFacetsId[iloc];
00519             \textcolor{keyword}{const} \hyperlink{classFVCode3D_1_1Rigid__Mesh_1_1Facet}{Rigid\_Mesh::Facet} & fac = facetVectorRef[i];
00520             \textcolor{keyword}{const} \hyperlink{namespaceFVCode3D_a40c1f5588a248569d80aa5f867080e83}{Real} Bcoeff = Bp(0,iloc);
00521             
00522             \textcolor{comment}{// This is to take into account the decoupling of fractures facets}
00523                         \textcolor{keywordflow}{if}( fac.\hyperlink{classFVCode3D_1_1Rigid__Mesh_1_1Facet_aed3f579d52847e839501f647e90c35ab}{isFracture}() && (cell.orientationFacet(fac)<0) )
00524                                         i = numFacets + fac.\hyperlink{classFVCode3D_1_1Rigid__Mesh_1_1Facet_a08dc369eccd02b29133187cede7511eb}{getFractureFacetId}();
00525 
00526             \textcolor{keywordflow}{if}( Bcoeff != 0. )\{
00527 
00528                                 S.insert(numFacetsTot + cellId, i) = Bcoeff;
00529                                 S.insert(i, numFacetsTot + cellId) = Bcoeff;
00530                         \}
00531 
00532             \hyperlink{namespaceFVCode3D_a40c1f5588a248569d80aa5f867080e83}{Real} Mcoeff = Mp(iloc,iloc);
00533 
00534             \textcolor{keywordflow}{if}( Mcoeff != 0. )
00535                 S.coeffRef(i,i) += Mcoeff;
00536 
00537             \textcolor{keywordflow}{for}(\hyperlink{namespaceFVCode3D_a4bf7e328c75d0fd504050d040ebe9eda}{UInt} jloc=iloc+1; jloc<numCellFacets; ++jloc)\{
00538 
00539                 \hyperlink{namespaceFVCode3D_a4bf7e328c75d0fd504050d040ebe9eda}{UInt} j = cellFacetsId[jloc];
00540                 \textcolor{keyword}{const} \hyperlink{classFVCode3D_1_1Rigid__Mesh_1_1Facet}{Rigid\_Mesh::Facet} & fac = facetVectorRef[j];
00541                 Mcoeff = Mp(iloc,jloc);
00542                 
00543                 \textcolor{comment}{// This is to take into account the decoupling of fractures facets}
00544                                 \textcolor{keywordflow}{if}( fac.\hyperlink{classFVCode3D_1_1Rigid__Mesh_1_1Facet_aed3f579d52847e839501f647e90c35ab}{isFracture}() && (cell.orientationFacet(fac)<0) )
00545                                         j = numFacets + fac.\hyperlink{classFVCode3D_1_1Rigid__Mesh_1_1Facet_a08dc369eccd02b29133187cede7511eb}{getFractureFacetId}();
00546 
00547                 \textcolor{keywordflow}{if} (Mcoeff != 0.)\{
00548                     S.coeffRef(i,j) += Mcoeff;
00549                     S.coeffRef(j,i) += Mcoeff;
00550                 \}
00551                 
00552             \}
00553 
00554         \}
00555     \}
00556     
00557 
00558     std::cout << \textcolor{stringliteral}{"Zero the Neumann row of S"} << std::endl;
00559     
00560         \textcolor{keywordflow}{for}( \textcolor{keyword}{auto} facet\_it : this->\hyperlink{classFVCode3D_1_1MatrixHandler_a72f185cb557fc2e8023bd09a074f685c}{M\_mesh}.\hyperlink{classFVCode3D_1_1Rigid__Mesh_aa72b7fad937f0d1586fc10b176ef5d3e}{getBorderFacetsIdsVector}() )\{
00561                 
00562                 \hyperlink{namespaceFVCode3D_a4bf7e328c75d0fd504050d040ebe9eda}{UInt} borderId = facet\_it.getBorderId();
00563                 \hyperlink{namespaceFVCode3D_a4bf7e328c75d0fd504050d040ebe9eda}{UInt} facetId  = facet\_it.getId();
00564                 
00565                 \textcolor{keywordflow}{if}( this->\hyperlink{classFVCode3D_1_1StiffMatrix_a23e3ffc97fcf112958e9966cac41e9d3}{M\_bc}.\hyperlink{classFVCode3D_1_1BoundaryConditions_a5b53a81bdab88709fae14892bfe6a7c9}{getBordersBCMap}().at(borderId).getBCType() == 
      \hyperlink{namespaceFVCode3D_a73660061f11f1671164ce171a053f8c5a30212425b27314b01b40f4984dbf850a}{Neumann} )\{
00566                         
00567                         S.prune( [facetId]( \hyperlink{namespaceFVCode3D_a4bf7e328c75d0fd504050d040ebe9eda}{UInt} i, \hyperlink{namespaceFVCode3D_a4bf7e328c75d0fd504050d040ebe9eda}{UInt}, \hyperlink{namespaceFVCode3D_a40c1f5588a248569d80aa5f867080e83}{Real} )\{ \textcolor{keywordflow}{return} ( i!= facetId ); \});
00568                         
00569                         S.coeffRef(facetId,facetId) = 1;
00570                         
00571                         \}
00572                 
00573                 \}  
00574 
00575 
00576     std::cout<<\textcolor{stringliteral}{" Num Cells: "}<<numCells<<std::endl;
00577     std::cout<<\textcolor{stringliteral}{" Num Facets: "}<<numFacets<<std::endl;
00578     std::cout<<\textcolor{stringliteral}{" Num Facets + Fracs: "}<<numFacetsTot<<std::endl;
00579     std::cout<<\textcolor{stringliteral}{" Num Cells + Fracs: "}<<numCellsTot<<std::endl;
00580     std::cout<<\textcolor{stringliteral}{" Num GDL: "}<<numGDL<<std::endl;
00581 
00582 
00583 
00584         \textcolor{comment}{// Loop to avoid memory reallocation}
00585         \textcolor{comment}{// This is for Ct}
00586         std::fill( Matrix\_elements.begin(), Matrix\_elements.begin() + (numFacetsTot+numCells-1), 0);    
00587     std::fill( Matrix\_elements.begin() + numFacetsTot+numCells, Matrix\_elements.end(), 2);
00588     
00589     \textcolor{keywordflow}{for} (\textcolor{keyword}{auto}& facet\_it : this->\hyperlink{classFVCode3D_1_1MatrixHandler_a72f185cb557fc2e8023bd09a074f685c}{M\_mesh}.\hyperlink{classFVCode3D_1_1Rigid__Mesh_aadbe6d9ad704122537903396d91238e0}{getFractureFacetsIdsVector}())\{
00590                 
00591                 \textcolor{comment}{//This is for -T}
00592                 \textcolor{keyword}{auto} f\_neighbors = facet\_it.getFractureNeighbors();
00593                 \hyperlink{namespaceFVCode3D_a4bf7e328c75d0fd504050d040ebe9eda}{UInt} N\_neighbors = 0;
00594         \textcolor{keyword}{auto} sum\_maker = [&N\_neighbors](std::pair< Fracture\_Juncture, std::vector<UInt> > p)\{N\_neighbors +=
       p.second.size() ;\};
00595         std::for\_each(f\_neighbors.begin(), f\_neighbors.end(), sum\_maker);
00596                 Matrix\_elements[ numFacetsTot+numCells + facet\_it.getFractureId() ] += N\_neighbors + 1;
00597                 
00598                 \textcolor{comment}{// This is for C and coupling terms on M}
00599                 \hyperlink{namespaceFVCode3D_a4bf7e328c75d0fd504050d040ebe9eda}{UInt} Id\_plus   = facet\_it.getId();
00600                 \hyperlink{namespaceFVCode3D_a4bf7e328c75d0fd504050d040ebe9eda}{UInt} Id\_minus  = numFacets + facet\_it.getFractureId();
00601                 Matrix\_elements[ Id\_plus ]   += 2;
00602                 Matrix\_elements[ Id\_minus ]  += 2;
00603                 
00604         \}
00605     
00606     S.reserve(Matrix\_elements);
00607     Matrix\_elements.clear();
00608     Matrix\_elements.shrink\_to\_fit();
00609 
00610 
00611     \textcolor{comment}{// Assemble fractures with FV and impose coupling conditions}
00612     \textcolor{keywordflow}{for} (\textcolor{keyword}{auto}& facet\_it : this->\hyperlink{classFVCode3D_1_1MatrixHandler_a72f185cb557fc2e8023bd09a074f685c}{M\_mesh}.\hyperlink{classFVCode3D_1_1Rigid__Mesh_aadbe6d9ad704122537903396d91238e0}{getFractureFacetsIdsVector}())\{
00613                 
00614         \textcolor{keyword}{auto}& F\_permeability = \hyperlink{classFVCode3D_1_1MatrixHandler_ad17a7941b1b8272f50fc6e1c660103fa}{M\_properties}.\hyperlink{classFVCode3D_1_1PropertiesMap_ace888d15c9a4ab13d5e217a3a565604c}{getProperties}(facet\_it.getZoneCode()).
      M\_permeability;
00615         \textcolor{keyword}{const} \hyperlink{namespaceFVCode3D_a40c1f5588a248569d80aa5f867080e83}{Real} Kfn = F\_permeability->operator()(0,0);
00616         \textcolor{keyword}{const} \hyperlink{namespaceFVCode3D_a40c1f5588a248569d80aa5f867080e83}{Real} F\_aperture = \hyperlink{classFVCode3D_1_1MatrixHandler_ad17a7941b1b8272f50fc6e1c660103fa}{M\_properties}.\hyperlink{classFVCode3D_1_1PropertiesMap_ace888d15c9a4ab13d5e217a3a565604c}{getProperties}(facet\_it.
      getZoneCode()).M\_aperture;
00617                 \textcolor{keyword}{const} \hyperlink{namespaceFVCode3D_a40c1f5588a248569d80aa5f867080e83}{Real} eta = F\_aperture / Kfn;
00618                 
00619                 \textcolor{keyword}{const} \hyperlink{namespaceFVCode3D_a4bf7e328c75d0fd504050d040ebe9eda}{UInt} Id\_plus         = facet\_it.getId();
00620                 \textcolor{keyword}{const} \hyperlink{namespaceFVCode3D_a4bf7e328c75d0fd504050d040ebe9eda}{UInt} Id\_F            = facet\_it.getFractureId();
00621                 \textcolor{keyword}{const} \hyperlink{namespaceFVCode3D_a4bf7e328c75d0fd504050d040ebe9eda}{UInt} Id\_minus        = numFacets + Id\_F;
00622                 \textcolor{keyword}{const} \hyperlink{namespaceFVCode3D_a40c1f5588a248569d80aa5f867080e83}{Real} facetMeasure    = facet\_it.getSize();
00623                 
00624                 \textcolor{comment}{// Coupling terms on M}
00625                 S.coeffRef(Id\_plus,Id\_plus)    +=   eta*facetMeasure/4. + eta*xsi0*facetMeasure;
00626                 S.coeffRef(Id\_plus,Id\_minus)   +=   eta*facetMeasure/4. - eta*xsi0*facetMeasure;
00627                 S.coeffRef(Id\_minus,Id\_minus)  +=   eta*facetMeasure/4. + eta*xsi0*facetMeasure;
00628                 S.coeffRef(Id\_minus,Id\_plus)   +=   eta*facetMeasure/4. - eta*xsi0*facetMeasure;
00629                 
00630                 \textcolor{comment}{// Coupling matrix Ct and C}
00631                 S.insert(Id\_plus, numFacetsTot+numCells + Id\_F)     =  facetMeasure;
00632                 S.insert(Id\_minus, numFacetsTot+numCells + Id\_F)    = -facetMeasure;
00633                 S.insert(numFacetsTot+numCells + Id\_F, Id\_plus)     =  facetMeasure;
00634                 S.insert(numFacetsTot+numCells + Id\_F, Id\_minus)    = -facetMeasure;
00635         
00636                 \textcolor{comment}{// Assemble -T matrix taking into account fractures intersections with the "star-delta"
       transformation}
00637         \textcolor{keywordflow}{for} (\textcolor{keyword}{auto} juncture\_it : facet\_it.getFractureNeighbors())\{
00638                         
00639             std::vector<Real> alphas;
00640             \textcolor{keyword}{const} \hyperlink{namespaceFVCode3D_a40c1f5588a248569d80aa5f867080e83}{Real} alphaF = \hyperlink{classFVCode3D_1_1StiffMatrix_a53ce514c7a4c784061b5339350e00995}{findFracturesAlpha} (juncture\_it.first, facet\_it.
      getFractureId());
00641 
00642             \textcolor{keywordflow}{for} (\textcolor{keyword}{auto} neighbors\_it : juncture\_it.second)
00643                 alphas.emplace\_back(\hyperlink{classFVCode3D_1_1StiffMatrix_a53ce514c7a4c784061b5339350e00995}{findFracturesAlpha} (juncture\_it.first, neighbors\_it))
      ;
00644 
00645             \hyperlink{namespaceFVCode3D_a40c1f5588a248569d80aa5f867080e83}{Real} a\_sum = alphaF;
00646             \textcolor{keyword}{auto} sum\_maker = [&a\_sum](\hyperlink{namespaceFVCode3D_a40c1f5588a248569d80aa5f867080e83}{Real} item)\{a\_sum += item;\};
00647             std::for\_each(alphas.begin(), alphas.end(), sum\_maker);
00648 
00649             \textcolor{keywordflow}{for} (\hyperlink{namespaceFVCode3D_a4bf7e328c75d0fd504050d040ebe9eda}{UInt} counter = 0; counter < alphas.size(); ++counter)\{
00650                                 
00651                 \textcolor{keyword}{const} \hyperlink{namespaceFVCode3D_a40c1f5588a248569d80aa5f867080e83}{Real} QFf = alphaF * alphas[counter] * \hyperlink{classFVCode3D_1_1MatrixHandler_ad17a7941b1b8272f50fc6e1c660103fa}{M\_properties}.
      \hyperlink{classFVCode3D_1_1PropertiesMap_a810ea62ca881e4db57acd601bcea23cf}{getMobility}() / a\_sum;
00652                 
00653                 S.coeffRef( numFacetsTot+numCells + Id\_F, numFacetsTot+numCells + Id\_F ) -= QFf;
00654                 
00655                 S.insert( numFacetsTot+numCells + Id\_F, numFacetsTot+numCells + juncture\_it.second[counter]
      ) = QFf; 
00656                 
00657             \}
00658             alphas.clear();
00659         \}
00660     \}
00661                             
00662     S.makeCompressed();                      
00663 
00664     \textcolor{comment}{// assemble BC on porous matrix}
00665     \textcolor{keywordflow}{for} (\textcolor{keyword}{auto}& facet\_it : this->\hyperlink{classFVCode3D_1_1MatrixHandler_a72f185cb557fc2e8023bd09a074f685c}{M\_mesh}.\hyperlink{classFVCode3D_1_1Rigid__Mesh_aa72b7fad937f0d1586fc10b176ef5d3e}{getBorderFacetsIdsVector}())\{
00666                 
00667         \textcolor{keyword}{const} \hyperlink{namespaceFVCode3D_a4bf7e328c75d0fd504050d040ebe9eda}{UInt} borderId = facet\_it.getBorderId();
00668         \textcolor{keyword}{const} \hyperlink{namespaceFVCode3D_a4bf7e328c75d0fd504050d040ebe9eda}{UInt} facetId = facet\_it.getId();
00669 
00670         \textcolor{keywordflow}{if}(\hyperlink{classFVCode3D_1_1StiffMatrix_a23e3ffc97fcf112958e9966cac41e9d3}{M\_bc}.\hyperlink{classFVCode3D_1_1BoundaryConditions_a5b53a81bdab88709fae14892bfe6a7c9}{getBordersBCMap}().at(borderId).getBCType() == 
      \hyperlink{namespaceFVCode3D_a73660061f11f1671164ce171a053f8c5a30212425b27314b01b40f4984dbf850a}{Neumann} )\{
00671                         
00672             \textcolor{keyword}{const} \hyperlink{namespaceFVCode3D_a40c1f5588a248569d80aa5f867080e83}{Real} vel\_N = \hyperlink{classFVCode3D_1_1StiffMatrix_a23e3ffc97fcf112958e9966cac41e9d3}{M\_bc}.\hyperlink{classFVCode3D_1_1BoundaryConditions_a5b53a81bdab88709fae14892bfe6a7c9}{getBordersBCMap}().at(borderId).getBC()(facet\_it.
      getCentroid());
00673             rhs[facetId] = vel\_N;
00674         \}
00675         
00676         \textcolor{keywordflow}{else} \textcolor{keywordflow}{if}(\hyperlink{classFVCode3D_1_1StiffMatrix_a23e3ffc97fcf112958e9966cac41e9d3}{M\_bc}.\hyperlink{classFVCode3D_1_1BoundaryConditions_a5b53a81bdab88709fae14892bfe6a7c9}{getBordersBCMap}().at(borderId).getBCType() == 
      \hyperlink{namespaceFVCode3D_a73660061f11f1671164ce171a053f8c5a192024697bdaa4fbbb39b8961b747bce}{Dirichlet})\{
00677                         
00678                         \hyperlink{namespaceFVCode3D_a40c1f5588a248569d80aa5f867080e83}{Real} pD = \hyperlink{classFVCode3D_1_1StiffMatrix_a23e3ffc97fcf112958e9966cac41e9d3}{M\_bc}.\hyperlink{classFVCode3D_1_1BoundaryConditions_a5b53a81bdab88709fae14892bfe6a7c9}{getBordersBCMap}().at(borderId).getBC()(
      facet\_it.getCentroid());
00679                         rhs[facetId] *= pD;
00680                 \}
00681     \}
00682 
00683     \textcolor{comment}{// assemble BC on fractures}
00684     \textcolor{keywordflow}{for} (\textcolor{keyword}{auto}& edge\_it : this->\hyperlink{classFVCode3D_1_1MatrixHandler_a72f185cb557fc2e8023bd09a074f685c}{M\_mesh}.\hyperlink{classFVCode3D_1_1Rigid__Mesh_a12c92b683cfb3d9ac2645f038a8c6220}{getBorderTipEdgesIdsVector}())\{
00685                 
00686         \textcolor{keywordtype}{bool} isD = \textcolor{keyword}{false};
00687         \hyperlink{namespaceFVCode3D_a4bf7e328c75d0fd504050d040ebe9eda}{UInt} borderId = 0;
00688 
00689         \textcolor{comment}{// select which BC to apply}
00690         \textcolor{keywordflow}{for}(\textcolor{keyword}{auto} border\_it : edge\_it.getBorderIds())\{
00691                         
00692             \textcolor{comment}{// BC = D > N && the one with greatest id}
00693             \textcolor{keywordflow}{if}(\hyperlink{classFVCode3D_1_1StiffMatrix_a23e3ffc97fcf112958e9966cac41e9d3}{M\_bc}.\hyperlink{classFVCode3D_1_1BoundaryConditions_a5b53a81bdab88709fae14892bfe6a7c9}{getBordersBCMap}().at(border\_it).getBCType() == 
      \hyperlink{namespaceFVCode3D_a73660061f11f1671164ce171a053f8c5a192024697bdaa4fbbb39b8961b747bce}{Dirichlet})\{
00694                                 
00695                 \textcolor{keywordflow}{if}(!isD)\{
00696                     isD = \textcolor{keyword}{true};
00697                     borderId = border\_it;
00698                 \}
00699                 \textcolor{keywordflow}{else}
00700                     borderId = (border\_it > borderId) ? border\_it : borderId;
00701             \}
00702             \textcolor{keywordflow}{else} \textcolor{keywordflow}{if}(!isD && \hyperlink{classFVCode3D_1_1StiffMatrix_a23e3ffc97fcf112958e9966cac41e9d3}{M\_bc}.\hyperlink{classFVCode3D_1_1BoundaryConditions_a5b53a81bdab88709fae14892bfe6a7c9}{getBordersBCMap}().at(border\_it).getBCType() == 
      \hyperlink{namespaceFVCode3D_a73660061f11f1671164ce171a053f8c5a30212425b27314b01b40f4984dbf850a}{Neumann})\{
00703                                 
00704                 borderId = (border\_it > borderId) ? border\_it : borderId;
00705                         \}
00706         \}
00707 
00708         \textcolor{comment}{// loop over the fracture facets to impose BC on fractures}
00709         \textcolor{keywordflow}{for}(\textcolor{keyword}{auto} facet\_it : edge\_it.getSeparatedFacetsIds())\{
00710                          
00711             \textcolor{keywordflow}{if}(facetVectorRef[facet\_it].isFracture())\{
00712                                 
00713                 \textcolor{keyword}{const} \hyperlink{namespaceFVCode3D_a4bf7e328c75d0fd504050d040ebe9eda}{UInt} neighborId = facetVectorRef[facet\_it].getFractureFacetId();
00714                 \textcolor{keyword}{const} \hyperlink{namespaceFVCode3D_a40c1f5588a248569d80aa5f867080e83}{Real} aperture = \hyperlink{classFVCode3D_1_1MatrixHandler_ad17a7941b1b8272f50fc6e1c660103fa}{M\_properties}.\hyperlink{classFVCode3D_1_1PropertiesMap_ace888d15c9a4ab13d5e217a3a565604c}{getProperties}( 
      facetVectorRef[facet\_it].getZoneCode() ).M\_aperture;
00715 
00716                 \textcolor{keywordflow}{if}(\hyperlink{classFVCode3D_1_1StiffMatrix_a23e3ffc97fcf112958e9966cac41e9d3}{M\_bc}.\hyperlink{classFVCode3D_1_1BoundaryConditions_a5b53a81bdab88709fae14892bfe6a7c9}{getBordersBCMap}().at(borderId).getBCType() == 
      \hyperlink{namespaceFVCode3D_a73660061f11f1671164ce171a053f8c5a30212425b27314b01b40f4984dbf850a}{Neumann})\{
00717                                         
00718                     \textcolor{keyword}{const} \hyperlink{namespaceFVCode3D_a40c1f5588a248569d80aa5f867080e83}{Real} Q1o = \hyperlink{classFVCode3D_1_1StiffMatrix_a23e3ffc97fcf112958e9966cac41e9d3}{M\_bc}.\hyperlink{classFVCode3D_1_1BoundaryConditions_a5b53a81bdab88709fae14892bfe6a7c9}{getBordersBCMap}().at(borderId).getBC()(
      edge\_it.getCentroid()) * edge\_it.getSize() * aperture;
00719                     rhs[ numFacetsTot+numCells + neighborId ] += Q1o;
00720                 \} \textcolor{comment}{// if}
00721                 
00722                 \textcolor{keywordflow}{else} \textcolor{keywordflow}{if}(\hyperlink{classFVCode3D_1_1StiffMatrix_a23e3ffc97fcf112958e9966cac41e9d3}{M\_bc}.\hyperlink{classFVCode3D_1_1BoundaryConditions_a5b53a81bdab88709fae14892bfe6a7c9}{getBordersBCMap}().at(borderId).getBCType() == 
      \hyperlink{namespaceFVCode3D_a73660061f11f1671164ce171a053f8c5a192024697bdaa4fbbb39b8961b747bce}{Dirichlet})\{
00723                                         
00724                     \textcolor{keyword}{const} \hyperlink{namespaceFVCode3D_a40c1f5588a248569d80aa5f867080e83}{Real} alpha1 = \hyperlink{classFVCode3D_1_1StiffMatrix_a2365673b4791819e78c4c593e2f63b28}{findAlpha} (facet\_it, &edge\_it);
00725                     \textcolor{keyword}{const} \hyperlink{namespaceFVCode3D_a40c1f5588a248569d80aa5f867080e83}{Real} alpha2 = \hyperlink{classFVCode3D_1_1StiffMatrix_aec36126e4870fc3f94a2d36b831c739e}{findDirichletAlpha} (facet\_it, &edge\_it);
00726 
00727                     \textcolor{keyword}{const} \hyperlink{namespaceFVCode3D_a40c1f5588a248569d80aa5f867080e83}{Real} T12 = 2 * alpha1*alpha2/(alpha1 + alpha2);
00728                     \textcolor{keyword}{const} \hyperlink{namespaceFVCode3D_a40c1f5588a248569d80aa5f867080e83}{Real} Q12 = T12 * \hyperlink{classFVCode3D_1_1MatrixHandler_ad17a7941b1b8272f50fc6e1c660103fa}{M\_properties}.
      \hyperlink{classFVCode3D_1_1PropertiesMap_a810ea62ca881e4db57acd601bcea23cf}{getMobility}();
00729                     \textcolor{keyword}{const} \hyperlink{namespaceFVCode3D_a40c1f5588a248569d80aa5f867080e83}{Real} Q1o = Q12 * \hyperlink{classFVCode3D_1_1StiffMatrix_a23e3ffc97fcf112958e9966cac41e9d3}{M\_bc}.\hyperlink{classFVCode3D_1_1BoundaryConditions_a5b53a81bdab88709fae14892bfe6a7c9}{getBordersBCMap}().at(borderId).getBC
      ()(edge\_it.getCentroid());
00730 
00731                     S.coeffRef( numFacetsTot+numCells + neighborId, numFacetsTot+numCells + neighborId) -= 
      Q12; 
00732                     rhs[ numFacetsTot+numCells + neighborId ] -= Q1o;
00733 
00734                 \} \textcolor{comment}{// else if}
00735             \} \textcolor{comment}{// if}
00736         \}\textcolor{comment}{// for}
00737     \} \textcolor{comment}{// for}
00738     
00739     std::cout<<\textcolor{stringliteral}{" Assembling ended"}<<std::endl;
00740     
00741     
00742 \} \textcolor{comment}{// StiffMatrix::assembleMFD}
00743 
00744 \} \textcolor{comment}{// namespace FVCode3D}
\end{DoxyCode}
